<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="AI Chrome Chat Manager - Modern AI Orchestration with Multi-Specialist Coordination">
    <meta name="keywords" content="AI, ChatGPT, Claude, Gemini, Orchestrator, AI Management">
    <meta name="author" content="AI Chrome Chat Manager">
    <meta name="theme-color" content="#ffffff">
    
    <title>🤖 AI Orchestrator - Universal Edition | Smart AI Coordination</title>
    
    <!-- Preload critical resources -->
    <link rel="preload" href="/static/css/design-system.css" as="style">
    <link rel="preload" href="/static/js/theme-manager.js" as="script">
    <link rel="preload" href="/static/js/animation-utils.js" as="script">
    
    <!-- External CDN -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
    
    <!-- Rich Text Editor - Tiptap -->
    <link rel="stylesheet" href="https://unpkg.com/@tiptap/core@2.1.13/dist/style.css">
    <link rel="stylesheet" href="https://unpkg.com/@tiptap/extension-typography@2.1.13/dist/style.css">
    
    <!-- Our Design System -->
    <link rel="stylesheet" href="/static/css/design-system.css">
    
    <style>
        /* Template-specific enhancements */
        .hero-section {
            background: linear-gradient(135deg, var(--primary-500) 0%, var(--primary-700) 100%);
            color: var(--text-inverse);
            padding: var(--space-20) 0;
            margin-bottom: var(--space-12);
            position: relative;
            overflow: hidden;
        }

        .hero-section::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><defs><pattern id="grain" width="100" height="100" patternUnits="userSpaceOnUse"><circle cx="50" cy="50" r="1" fill="rgba(255,255,255,0.1)"/></pattern></defs><rect width="100" height="100" fill="url(%23grain)"/></svg>');
            opacity: 0.3;
        }

        .hero-content {
            position: relative;
            z-index: 2;
        }

        [data-theme="dark"] .hero-section {
            background: linear-gradient(135deg, var(--secondary-800) 0%, var(--secondary-900) 100%);
        }

        /* Enhanced navbar */
        .navbar {
            background: var(--bg-surface) !important;
            backdrop-filter: blur(20px);
            border-bottom: 1px solid var(--border-primary);
            box-shadow: var(--shadow-sm);
        }

        .navbar-brand {
            font-weight: var(--font-weight-bold);
            color: var(--text-primary) !important;
            font-size: var(--font-size-xl);
        }

        /* Enhanced tab navigation */
        .nav-tabs {
            border-bottom: 2px solid var(--border-primary);
            margin-bottom: var(--space-8);
        }
        
        .nav-tabs .nav-link {
            color: var(--text-secondary);
            border: none;
            padding: var(--space-4) var(--space-6);
            font-weight: var(--font-weight-medium);
            transition: all var(--transition-base);
            border-radius: var(--radius-md) var(--radius-md) 0 0;
            position: relative;
        }
        
        .nav-tabs .nav-link:hover {
            color: var(--primary-500);
            background: var(--bg-tertiary);
        }
        
        .nav-tabs .nav-link.active {
            color: var(--primary-500);
            background: var(--bg-surface);
            border-bottom: 3px solid var(--primary-500);
        }

        /* Enhanced metrics cards */
        .metric-card {
            background: var(--bg-surface);
            border: 1px solid var(--border-primary);
            border-radius: var(--radius-lg);
            padding: var(--space-6);
            box-shadow: var(--shadow-md);
            transition: all var(--transition-base);
            height: 100%;
            position: relative;
            overflow: hidden;
        }

        .metric-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: var(--gradient-primary);
            opacity: 0;
            transition: opacity var(--transition-base);
        }

        .metric-card:hover::before {
            opacity: 1;
        }

        .metric-card:hover {
            transform: translateY(-4px);
            box-shadow: var(--shadow-xl);
        }

        .metric-card.cost::before { background: var(--gradient-success); }
        .metric-card.requests::before { background: var(--gradient-primary); }
        .metric-card.success::before { background: var(--gradient-warning); }
        .metric-card.speed::before { background: var(--gradient-danger); }

        /* Enhanced AI cards */
        .ai-card {
            background: var(--bg-surface);
            border: 1px solid var(--border-primary);
            border-radius: var(--radius-lg);
            padding: var(--space-6);
            box-shadow: var(--shadow-md);
            transition: all var(--transition-base);
            height: 100%;
        }
        
        .ai-card:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }

        /* Enhanced chat interface */
        .chat-container {
            background: var(--bg-surface);
            border: 1px solid var(--border-primary);
            border-radius: var(--radius-xl);
            box-shadow: var(--shadow-lg);
            overflow: hidden;
            height: 600px;
            display: flex;
            flex-direction: column;
        }
        
        .chat-header {
            padding: var(--space-6);
            border-bottom: 1px solid var(--border-primary);
            background: var(--bg-tertiary);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: var(--space-6);
            background: var(--bg-secondary);
        }

        .chat-input {
            padding: var(--space-6);
            border-top: 1px solid var(--border-primary);
            background: var(--bg-surface);
        }

        /* Connection status indicator */
        .connection-status {
            display: flex;
            align-items: center;
            gap: var(--space-2);
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }

        .status-dot.online {
            background: var(--success-500);
        }

        .status-dot.offline {
            background: var(--danger-500);
        }

        /* Responsive adjustments */
        @media (max-width: 768px) {
            .hero-section {
                padding: var(--space-12) 0;
            }

            .metric-card {
                margin-bottom: var(--space-4);
            }

            .nav-tabs .nav-link {
                padding: var(--space-3) var(--space-4);
                font-size: var(--font-size-sm);
            }
        }

        /* AI Orchestration Styles */
        .ai-participant-card {
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius-lg);
            padding: var(--space-4);
            transition: all var(--transition-base);
            position: relative;
            overflow: hidden;
        }

        .ai-participant-card:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
            border-color: var(--primary-300);
        }

        .participant-header {
            display: flex;
            align-items: center;
            gap: var(--space-3);
            margin-bottom: var(--space-2);
        }

        .participant-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            color: white;
        }

        .participant-info {
            flex: 1;
        }

        .participant-name {
            font-weight: 600;
            color: var(--text-primary);
            font-size: var(--font-size-sm);
        }

        .participant-status {
            font-size: var(--font-size-xs);
            color: var(--text-secondary);
            margin-top: 2px;
        }

        .participant-model {
            font-size: var(--font-size-xs);
            color: var(--text-muted);
            font-family: monospace;
        }

        .participant-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: var(--danger-500);
            position: relative;
        }

        .participant-indicator.online {
            background: var(--success-500);
            animation: pulse 2s infinite;
        }

        .participant-indicator.thinking {
            background: var(--warning-500);
            animation: blink 1s infinite;
        }

        .participant-stats {
            margin-top: var(--space-2);
            padding-top: var(--space-2);
            border-top: 1px solid var(--border-color);
        }

        /* Multi-AI Conversation Messages */
        .ai-conversation-message {
            margin-bottom: var(--space-4);
            padding: var(--space-4);
            border-radius: var(--border-radius-lg);
            border-left: 4px solid;
            animation: slideInRight 0.3s ease-out;
        }

        .ai-conversation-message.pm {
            background: rgba(var(--primary-500-rgb), 0.1);
            border-left-color: var(--primary-500);
        }

        .ai-conversation-message.dev {
            background: rgba(var(--success-500-rgb), 0.1);
            border-left-color: var(--success-500);
        }

        .ai-conversation-message.director {
            background: rgba(var(--warning-500-rgb), 0.1);
            border-left-color: var(--warning-500);
        }

        .ai-message-header {
            display: flex;
            align-items: center;
            gap: var(--space-2);
            margin-bottom: var(--space-2);
        }

        .ai-message-speaker {
            font-weight: 600;
            font-size: var(--font-size-sm);
        }

        .ai-message-meta {
            font-size: var(--font-size-xs);
            color: var(--text-secondary);
        }

        .ai-message-content {
            line-height: 1.6;
            color: var(--text-primary);
        }

        .ai-message-turn {
            position: absolute;
            top: var(--space-2);
            right: var(--space-2);
            background: var(--primary-500);
            color: white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: var(--font-size-xs);
            font-weight: 600;
        }

        /* Connection Status Styles */
        .connection-status-bar .badge {
            font-size: var(--font-size-xs);
            padding: var(--space-1) var(--space-2);
        }

        #ws-connection-badge.connected {
            background: var(--success-500) !important;
        }

        #ws-connection-badge.disconnected {
            background: var(--danger-500) !important;
        }

        #ws-connection-badge.connecting {
            background: var(--warning-500) !important;
        }

        /* Orchestration Controls */
        .orchestration-controls .btn-modern {
            white-space: nowrap;
        }

        /* Animations */
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }

        @keyframes blink {
            0%, 50% { opacity: 1; }
            51%, 100% { opacity: 0.3; }
        }

        @keyframes slideInRight {
            from {
                opacity: 0;
                transform: translateX(20px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        /* AI Performance Cards Styles */
        .ai-performance-card {
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius-lg);
            padding: var(--space-4);
            transition: all var(--transition-base);
            position: relative;
            overflow: hidden;
        }

        .ai-performance-card:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
            border-color: var(--primary-300);
        }

        .ai-performance-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 3px;
            background: linear-gradient(90deg, var(--primary-500), var(--success-500));
        }

        .ai-icon {
            font-size: 24px;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--primary-100);
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: var(--space-3);
        }

        .ai-name {
            font-weight: 600;
            color: var(--text-primary);
            font-size: var(--font-size-sm);
            margin-bottom: 2px;
        }

        .stats-row {
            display: flex;
            justify-content: space-between;
            margin-top: var(--space-3);
            padding-top: var(--space-3);
            border-top: 1px solid var(--border-color);
        }

        .stat {
            text-align: center;
            flex: 1;
        }

        .stat-value {
            font-weight: 700;
            font-size: var(--font-size-lg);
            color: var(--text-primary);
            margin-bottom: 2px;
        }

        .stat-label {
            font-size: var(--font-size-xs);
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        /* AI Performance Cards Animation */
        .ai-performance-card {
            animation: slideInUp 0.6s ease-out;
        }

        @keyframes slideInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* AI Performance Role-specific colors */
        .ai-performance-card[data-role="project_manager"] .ai-icon {
            background: var(--primary-100);
            color: var(--primary-600);
        }

        .ai-performance-card[data-role="project_manager"]::before {
            background: linear-gradient(90deg, var(--primary-500), var(--primary-400));
        }

        .ai-performance-card[data-role="lead_developer"] .ai-icon {
            background: var(--success-100);
            color: var(--success-600);
        }

        .ai-performance-card[data-role="lead_developer"]::before {
            background: linear-gradient(90deg, var(--success-500), var(--success-400));
        }

        .ai-performance-card[data-role="boss"] .ai-icon {
            background: var(--warning-100);
            color: var(--warning-600);
        }

        .ai-performance-card[data-role="boss"]::before {
            background: linear-gradient(90deg, var(--warning-500), var(--warning-400));
        }

        /* Status Badges Enhanced */
        .ai-performance-card .badge {
            font-size: var(--font-size-xs);
            padding: var(--space-1) var(--space-2);
            border-radius: var(--border-radius-full);
            font-weight: 600;
        }

        /* Empty State for AI Cards */
        .ai-cards-empty-state {
            text-align: center;
            padding: var(--space-8);
            color: var(--text-secondary);
        }

        .ai-cards-empty-state i {
            font-size: 48px;
            opacity: 0.3;
            margin-bottom: var(--space-3);
        }

        /* Responsive Adjustments */
        @media (max-width: 768px) {
            .orchestration-controls {
                flex-wrap: wrap;
                gap: var(--space-1) !important;
            }

            .orchestration-controls .btn-modern {
                flex: 1;
                min-width: 120px;
            }

            .participant-header {
                flex-direction: column;
                text-align: center;
                gap: var(--space-2);
            }

            .connection-status-bar {
                flex-wrap: wrap;
                gap: var(--space-1) !important;
            }

            .stats-row {
                flex-direction: column;
                gap: var(--space-2);
            }

            .stat {
                display: flex;
                justify-content: space-between;
                align-items: center;
                text-align: left;
            }

            .stat-value {
                order: 2;
            }

            .stat-label {
                order: 1;
            }
        }

        /* Print styles */
        @media print {
            .hero-section,
            .navbar,
            .nav-tabs,
            .chat-container {
                display: none !important;
            }
        }

        /* ===== 🎨 LIVE DOCUMENT CANVAS STYLES ===== */

        /* Floating Window Styles */
        .canvas-window {
            position: absolute;
            background: var(--bg-surface);
            border: 2px solid var(--border-primary);
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-xl);
            min-width: 400px;
            min-height: 300px;
            max-width: 800px;
            max-height: 600px;
            resize: both;
            overflow: hidden;
            transition: all var(--transition-base);
            z-index: 1000;
        }

        .canvas-window:hover {
            box-shadow: var(--shadow-2xl);
        }

        .canvas-window.focused {
            border-color: var(--primary-500);
            box-shadow: 0 0 0 3px rgba(var(--primary-500-rgb), 0.1), var(--shadow-2xl);
        }

        .canvas-window.minimized {
            height: 40px !important;
            overflow: hidden;
            resize: none;
        }

        .canvas-window-header {
            background: var(--bg-tertiary);
            border-bottom: 1px solid var(--border-primary);
            padding: var(--space-2) var(--space-3);
            cursor: move;
            display: flex;
            justify-content: between;
            align-items: center;
            user-select: none;
        }

        .canvas-window-title {
            flex: 1;
            font-weight: 600;
            font-size: var(--font-size-sm);
            color: var(--text-primary);
            margin: 0;
        }

        .canvas-window-controls {
            display: flex;
            gap: var(--space-1);
        }

        .canvas-window-control {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
            transition: all var(--transition-base);
        }

        .canvas-window-control.minimize {
            background: var(--warning-400);
            color: var(--warning-900);
        }

        .canvas-window-control.maximize {
            background: var(--success-400);
            color: var(--success-900);
        }

        .canvas-window-control.close {
            background: var(--danger-400);
            color: var(--danger-900);
        }

        .canvas-window-control:hover {
            transform: scale(1.2);
        }

        .canvas-window-content {
            height: calc(100% - 41px);
            padding: var(--space-3);
            overflow: auto;
        }

        /* Rich Text Editor Styles */
        .canvas-editor {
            border: none;
            outline: none;
            background: transparent;
            color: var(--text-primary);
            font-family: var(--font-family-base);
            font-size: var(--font-size-base);
            line-height: 1.6;
            min-height: 200px;
        }

        .canvas-editor.ProseMirror {
            border: none !important;
            outline: none !important;
        }

        .canvas-editor .ProseMirror {
            outline: none;
        }

        .canvas-editor h1 { 
            font-size: var(--font-size-2xl); 
            font-weight: 700; 
            margin: var(--space-4) 0 var(--space-2) 0;
            color: var(--text-primary);
        }

        .canvas-editor h2 { 
            font-size: var(--font-size-xl); 
            font-weight: 600; 
            margin: var(--space-3) 0 var(--space-2) 0;
            color: var(--text-primary);
        }

        .canvas-editor h3 { 
            font-size: var(--font-size-lg); 
            font-weight: 600; 
            margin: var(--space-3) 0 var(--space-1) 0;
            color: var(--text-primary);
        }

        .canvas-editor p { 
            margin: var(--space-2) 0; 
        }

        .canvas-editor ul, .canvas-editor ol { 
            margin: var(--space-2) 0; 
            padding-left: var(--space-6);
        }

        .canvas-editor li { 
            margin: var(--space-1) 0; 
        }

        .canvas-editor blockquote {
            border-left: 4px solid var(--primary-500);
            background: var(--bg-secondary);
            padding: var(--space-3);
            margin: var(--space-3) 0;
            border-radius: var(--radius-md);
        }

        .canvas-editor code {
            background: var(--bg-tertiary);
            padding: var(--space-1) var(--space-2);
            border-radius: var(--radius-sm);
            font-family: var(--font-family-mono);
            font-size: var(--font-size-sm);
        }

        .canvas-editor pre {
            background: var(--bg-tertiary);
            padding: var(--space-3);
            border-radius: var(--radius-md);
            overflow-x: auto;
            margin: var(--space-3) 0;
        }

        /* Canvas Toolbar */
        .canvas-toolbar {
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border-primary);
            padding: var(--space-2);
            display: flex;
            gap: var(--space-1);
            flex-wrap: wrap;
        }

        .canvas-toolbar-button {
            background: transparent;
            border: 1px solid var(--border-primary);
            border-radius: var(--radius-sm);
            padding: var(--space-1) var(--space-2);
            cursor: pointer;
            transition: all var(--transition-base);
            font-size: var(--font-size-sm);
            color: var(--text-secondary);
        }

        .canvas-toolbar-button:hover {
            background: var(--bg-tertiary);
            color: var(--text-primary);
        }

        .canvas-toolbar-button.active {
            background: var(--primary-500);
            color: white;
            border-color: var(--primary-500);
        }

        /* AI Collaboration Indicators */
        .ai-typing-indicator {
            position: absolute;
            bottom: var(--space-3);
            right: var(--space-3);
            background: var(--primary-500);
            color: white;
            padding: var(--space-1) var(--space-2);
            border-radius: var(--radius-full);
            font-size: var(--font-size-xs);
            animation: pulse 2s infinite;
        }

        .ai-edit-highlight {
            background: rgba(var(--primary-500-rgb), 0.2);
            border-radius: var(--radius-sm);
            padding: 1px 2px;
            animation: fadeHighlight 3s ease-out;
        }

        @keyframes fadeHighlight {
            0% { background: rgba(var(--primary-500-rgb), 0.4); }
            100% { background: transparent; }
        }

        /* Canvas Grid Layout */
        .canvas-grid-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            pointer-events: none;
            background-image: 
                linear-gradient(rgba(var(--border-primary-rgb), 0.1) 1px, transparent 1px),
                linear-gradient(90deg, rgba(var(--border-primary-rgb), 0.1) 1px, transparent 1px);
            background-size: 20px 20px;
            opacity: 0;
            transition: opacity var(--transition-base);
        }

        .canvas-container:hover .canvas-grid-overlay {
            opacity: 1;
        }

        /* Document Type Badges */
        .canvas-document-type {
            position: absolute;
            top: var(--space-1);
            right: var(--space-3);
            background: var(--primary-500);
            color: white;
            padding: var(--space-1) var(--space-2);
            border-radius: var(--radius-full);
            font-size: var(--font-size-xs);
            font-weight: 600;
        }

        .canvas-document-type.markdown { background: var(--info-500); }
        .canvas-document-type.rich_text { background: var(--success-500); }
        .canvas-document-type.collaborative { background: var(--warning-500); }
        .canvas-document-type.code_notes { background: var(--danger-500); }

        /* Responsive Canvas */
        @media (max-width: 768px) {
            .canvas-window {
                min-width: 300px;
                max-width: 100%;
                left: 0 !important;
                right: 0 !important;
                width: calc(100% - 20px) !important;
                margin: 0 10px;
            }
            
            .canvas-toolbar {
                padding: var(--space-1);
            }
            
            .canvas-toolbar-button {
                padding: var(--space-1);
                font-size: var(--font-size-xs);
            }
        }
    </style>
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg fixed-top">
        <div class="container-fluid">
            <a class="navbar-brand gradient-text" href="/">
                <i class="bi bi-robot"></i>
                AI Orchestrator
                <span class="badge bg-primary ms-2">v2.0</span>
            </a>
            
            <div class="navbar-nav me-auto">
                <a class="nav-link hover-lift" href="/api-management">
                    <i class="bi bi-key-fill"></i>
                    <span class="d-none d-sm-inline">API Yönetimi</span>
                </a>
            </div>
            
            <div class="navbar-nav ms-auto">
                <div class="connection-status">
                    <span class="status-dot online" id="status-indicator"></span>
                    <span class="text-sm" id="connection-status">Bağlı</span>
                </div>
                <!-- Theme toggle will be automatically added here by theme-manager.js -->
            </div>
        </div>
    </nav>

    <!-- Hero Section -->
    <section class="hero-section">
        <div class="container">
            <div class="hero-content text-center" data-animate="fadeInUp">
                <h1 class="display-4 font-bold mb-4">
                    🧠 AI Orchestrator Universal
                </h1>
                <p class="lead mb-6">
                    Akıllı uzman koordinasyonu ile AI güçlerini birleştirin
                </p>
                <div class="d-flex gap-3 justify-content-center flex-wrap">
                    <button class="btn-modern btn-primary btn-lg" onclick="scrollToSection('analytics')">
                        <i class="bi bi-graph-up"></i>
                        Dashboard'a Git
                    </button>
                    <button class="btn-modern btn-secondary btn-lg glass-effect" onclick="scrollToSection('chat')">
                        <i class="bi bi-chat-dots"></i>
                        Konuşmaya Başla
                    </button>
                </div>
            </div>
        </div>
    </section>

    <!-- Main Container -->
    <div class="container-fluid px-4" style="margin-top: 120px;">
        <!-- Tab Navigation -->
        <ul class="nav nav-tabs" id="mainTabs" role="tablist" data-animate="fadeInUp" data-delay="100">
            <li class="nav-item" role="presentation">
                <button class="nav-link active focus-ring" id="analytics-tab" data-bs-toggle="tab" data-bs-target="#analytics" type="button" role="tab">
                    <i class="bi bi-graph-up"></i>
                    <span class="d-none d-sm-inline ms-2">Analytics</span>
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link focus-ring" id="chat-tab" data-bs-toggle="tab" data-bs-target="#chat" type="button" role="tab">
                    <i class="bi bi-diagram-3"></i>
                    <span class="d-none d-sm-inline ms-2">🧠 AI Orkestra</span>
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link focus-ring" id="canvas-tab" data-bs-toggle="tab" data-bs-target="#canvas" type="button" role="tab">
                    <i class="bi bi-window-stack"></i>
                    <span class="d-none d-sm-inline ms-2">🎨 Canlı Belge Tuvali</span>
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link focus-ring" id="settings-tab" data-bs-toggle="tab" data-bs-target="#settings" type="button" role="tab">
                    <i class="bi bi-gear"></i>
                    <span class="d-none d-sm-inline ms-2">Ayarlar</span>
                </button>
            </li>
        </ul>

        <!-- Tab Content -->
        <div class="tab-content" id="mainTabContent">
            <!-- Analytics Tab -->
            <div class="tab-pane fade show active" id="analytics" role="tabpanel" aria-labelledby="analytics-tab">
                <div class="d-flex justify-content-between align-items-center mb-6" data-animate="fadeInUp" data-delay="200">
                    <div>
                        <h2 class="mb-2">📊 Analytics Dashboard</h2>
                        <p class="text-secondary mb-0">AI performans metrikleri ve sistem durumu</p>
                    </div>
                    <div class="d-flex gap-2">
                        <button class="btn-modern btn-secondary" onclick="showMemoryModal()">
                            <i class="bi bi-clock-history"></i>
                            <span class="d-none d-sm-inline">Geçmiş</span>
                        </button>
                        <button class="btn-modern btn-warning" onclick="showTasksModal()">
                            <i class="bi bi-list-task"></i>
                            <span class="d-none d-sm-inline">Görevler</span>
                            <span class="badge bg-white text-dark ms-1" id="active-tasks-count">0</span>
                        </button>
                    </div>
                </div>
                
                <!-- Primary Metrics -->
                <div class="row g-4 mb-6">
                    <div class="col-lg-3 col-md-6" data-animate="fadeInUp" data-delay="300">
                        <div class="metric-card cost">
                            <div class="d-flex align-items-center mb-3">
                                <div class="p-3 rounded-circle bg-success-100 text-success-600 me-3">
                                    <i class="bi bi-currency-dollar fs-5"></i>
                            </div>
                                <div>
                                    <div class="text-sm text-secondary">Toplam Maliyet</div>
                                    <div class="text-2xl font-bold" id="total-cost">$0.00</div>
                        </div>
                    </div>
                            <div class="text-sm text-success-600" id="cost-change">Başlangıç</div>
                        </div>
                    </div>
                    
                    <div class="col-lg-3 col-md-6" data-animate="fadeInUp" data-delay="400">
                        <div class="metric-card requests">
                            <div class="d-flex align-items-center mb-3">
                                <div class="p-3 rounded-circle bg-primary-100 text-primary-600 me-3">
                                    <i class="bi bi-arrow-repeat fs-5"></i>
                            </div>
                                <div>
                                    <div class="text-sm text-secondary">Toplam İstek</div>
                                    <div class="text-2xl font-bold" id="total-requests">0</div>
                        </div>
                    </div>
                            <div class="text-sm text-primary-600" id="requests-change">0 RPM</div>
                        </div>
                    </div>
                    
                    <div class="col-lg-3 col-md-6" data-animate="fadeInUp" data-delay="500">
                        <div class="metric-card success">
                            <div class="d-flex align-items-center mb-3">
                                <div class="p-3 rounded-circle bg-warning-100 text-warning-600 me-3">
                                    <i class="bi bi-check-circle fs-5"></i>
                            </div>
                                <div>
                                    <div class="text-sm text-secondary">Başarı Oranı</div>
                                    <div class="text-2xl font-bold" id="success-rate">100%</div>
                        </div>
                    </div>
                            <div class="text-sm text-danger-600" id="error-count">0 hata</div>
                        </div>
                    </div>
                    
                    <div class="col-lg-3 col-md-6" data-animate="fadeInUp" data-delay="600">
                        <div class="metric-card speed">
                            <div class="d-flex align-items-center mb-3">
                                <div class="p-3 rounded-circle bg-danger-100 text-danger-600 me-3">
                                    <i class="bi bi-lightning fs-5"></i>
                            </div>
                                <div>
                                    <div class="text-sm text-secondary">Ortalama Yanıt</div>
                                    <div class="text-2xl font-bold" id="avg-response">0.0s</div>
                                </div>
                            </div>
                            <div class="text-sm text-secondary" id="fastest-model">Bekleniyor</div>
                        </div>
                    </div>
                </div>

                <!-- Token Usage -->
                <div class="card-modern mb-6" data-animate="fadeInUp" data-delay="700">
                    <div class="card-header">
                        <h5 class="mb-0 d-flex align-items-center">
                            <i class="bi bi-bar-chart me-2"></i>
                            Token Kullanımı
                    </h5>
                    </div>
                    <div class="card-body">
                        <div class="d-flex justify-content-between mb-3">
                            <span class="text-sm">Toplam: <strong id="total-tokens">0</strong> token</span>
                            <span class="text-sm">
                            Input: <span id="input-tokens">0</span> (<span id="input-percentage">0%</span>) | 
                            Output: <span id="output-tokens">0</span> (<span id="output-percentage">0%</span>)
                        </span>
                    </div>
                        <div class="progress" style="height: 20px;">
                            <div class="progress-bar bg-primary" id="progress-input" style="width: 0%">0%</div>
                            <div class="progress-bar bg-success" id="progress-output" style="width: 0%">0%</div>
                        </div>
                    </div>
                </div>

                <!-- Live Conversation & AI Performance -->
                <div class="row g-4">
                    <!-- AI Performance Cards -->
                    <div class="col-lg-6">
                        <h5 class="mb-4" data-animate="fadeInLeft" data-delay="800">
                            <i class="bi bi-cpu"></i>
                            AI Performans Dökümü
                        </h5>
                        <div class="row g-3" id="ai-cards-container">
                            <!-- AI cards will be dynamically inserted here -->
                        </div>
                    </div>
                    
                    <!-- Live Conversation Stream -->
                    <div class="col-lg-6">
                        <div class="chat-container" data-animate="fadeInRight" data-delay="800">
                            <div class="chat-header">
                                <h5 class="mb-0">
                                    <i class="bi bi-chat-dots-fill"></i>
                                    Canlı AI Konuşması
                                </h5>
                                <div class="d-flex gap-2">
                                    <button class="btn-modern btn-success btn-sm" id="start-conversation" onclick="startAIConversation()">
                                        <i class="bi bi-play-fill"></i>
                                        <span class="d-none d-sm-inline">Başlat</span>
                                    </button>
                                    <button class="btn-modern btn-warning btn-sm" id="pause-conversation" onclick="pauseConversation()" disabled>
                                        <i class="bi bi-pause-fill"></i>
                                        <span class="d-none d-sm-inline">Duraklat</span>
                                    </button>
                                    <button class="btn-modern btn-danger btn-sm" id="clear-conversation" onclick="clearConversation()">
                                        <i class="bi bi-trash"></i>
                                    </button>
                                </div>
                            </div>
                            
                            <div class="chat-messages" id="live-chat-messages">
                                <div class="text-center text-muted p-5">
                                    <div class="floating">
                                    <i class="bi bi-robot" style="font-size: 48px; opacity: 0.3;"></i>
                                </div>
                                    <p class="mt-3 mb-0">AI konuşması başlatılmayı bekliyor...</p>
                                    <small class="text-muted">Yukarıdaki "Başlat" butonuna tıklayın</small>
                                </div>
                            </div>
                            
                            <div class="chat-input">
                                <div class="d-flex align-items-center justify-content-between text-sm">
                                    <span class="connection-status">
                                        <i class="bi bi-circle-fill text-secondary"></i>
                                        <span id="conversation-status">Beklemede</span>
                                </span>
                                    <span id="turn-counter">Tur: 0/0</span>
                                    <button class="btn-modern btn-warning btn-sm" id="toggle-intervention" onclick="toggleInterventionPanel()" style="display: none;">
                                        <i class="bi bi-megaphone"></i>
                                        Müdahale
                                </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Multi-AI Orchestration Tab -->
            <div class="tab-pane fade" id="chat" role="tabpanel" aria-labelledby="chat-tab">
                <!-- AI Orchestration Control Panel -->
                <div class="row mb-4">
                    <div class="col-12">
                        <div class="card-modern" data-animate="fadeInUp">
                            <div class="card-header d-flex justify-content-between align-items-center">
                                <h5 class="mb-0">
                                    <i class="bi bi-diagram-3"></i>
                                    🧠 Multi-AI Orchestration Center
                                </h5>
                                <div class="orchestration-controls d-flex gap-2">
                                    <button class="btn-modern btn-success" id="start-multi-ai" onclick="startMultiAIOrchestration()">
                                        <i class="bi bi-play-circle"></i>
                                        AI Orkestra Başlat
                                    </button>
                                    <button class="btn-modern btn-warning" id="pause-orchestration" onclick="pauseOrchestration()" disabled>
                                        <i class="bi bi-pause-circle"></i>
                                        Duraklat
                                    </button>
                                    <button class="btn-modern btn-info" onclick="showDirectorControl()">
                                        <i class="bi bi-megaphone"></i>
                                        Director Müdahale
                                    </button>
                                    <button class="btn-modern btn-secondary" onclick="clearOrchestration()">
                                        <i class="bi bi-arrow-clockwise"></i>
                                        Temizle
                                    </button>
                                </div>
                            </div>
                            <div class="card-body">
                                <!-- WebSocket Connection Status -->
                                <div class="connection-status-bar mb-3 d-flex align-items-center gap-3">
                                    <span class="badge" id="ws-connection-badge">
                                        <i class="bi bi-wifi" id="ws-icon"></i>
                                        WebSocket: <span id="ws-status">Bağlanıyor...</span>
                                    </span>
                                    <span class="badge bg-secondary">
                                        Orchestration: <span id="orchestration-status">Beklemede</span>
                                    </span>
                                    <span class="badge bg-info">
                                        Aktif Session: <span id="session-id">Yok</span>
                                    </span>
                                    <span class="badge bg-warning">
                                        Tur: <span id="current-turn">0</span>/<span id="max-turn">0</span>
                                    </span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- AI Participants Display -->
                <div class="row mb-4">
                    <div class="col-12">
                        <div class="card-modern" data-animate="fadeInUp" data-delay="200">
                            <div class="card-header">
                                <h6 class="mb-0">🤖 AI Katılımcıları</h6>
                            </div>
                            <div class="card-body">
                                <div class="row g-3" id="ai-participants-grid">
                                    <!-- Project Manager -->
                                    <div class="col-md-4">
                                        <div class="ai-participant-card" id="pm-participant">
                                            <div class="participant-header">
                                                <div class="participant-avatar bg-primary">👔</div>
                                                <div class="participant-info">
                                                    <div class="participant-name">Project Manager</div>
                                                    <div class="participant-status" id="pm-status">Standby</div>
                                                    <div class="participant-model" id="pm-model">gemini-primary</div>
                                                </div>
                                                <div class="participant-indicator" id="pm-indicator"></div>
                                            </div>
                                            <div class="participant-stats">
                                                <small class="text-muted">Mesaj: <span id="pm-message-count">0</span> | Maliyet: $<span id="pm-cost">0.00</span></small>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Lead Developer -->
                                    <div class="col-md-4">
                                        <div class="ai-participant-card" id="dev-participant">
                                            <div class="participant-header">
                                                <div class="participant-avatar bg-success">👨‍💻</div>
                                                <div class="participant-info">
                                                    <div class="participant-name">Lead Developer</div>
                                                    <div class="participant-status" id="dev-status">Standby</div>
                                                    <div class="participant-model" id="dev-model">gemini-secondary</div>
                                                </div>
                                                <div class="participant-indicator" id="dev-indicator"></div>
                                            </div>
                                            <div class="participant-stats">
                                                <small class="text-muted">Mesaj: <span id="dev-message-count">0</span> | Maliyet: $<span id="dev-cost">0.00</span></small>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Director (Boss) -->
                                    <div class="col-md-4">
                                        <div class="ai-participant-card" id="boss-participant">
                                            <div class="participant-header">
                                                <div class="participant-avatar bg-warning">👑</div>
                                                <div class="participant-info">
                                                    <div class="participant-name">Director</div>
                                                    <div class="participant-status" id="boss-status">Ready</div>
                                                    <div class="participant-model" id="boss-model">gemini-third</div>
                                                </div>
                                                <div class="participant-indicator" id="boss-indicator"></div>
                                            </div>
                                            <div class="participant-stats">
                                                <small class="text-muted">Müdahale: <span id="boss-intervention-count">0</span></small>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Real-time AI Conversation Display -->
                <div class="row">
                    <!-- Multi-AI Conversation Stream -->
                    <div class="col-lg-8">
                        <div class="card-modern" data-animate="fadeInUp" data-delay="400">
                            <div class="card-header">
                                <h6 class="mb-0">
                                    <i class="bi bi-chat-quote"></i>
                                    Real-time AI Conversation
                                </h6>
                            </div>
                            <div class="card-body p-0">
                                <div class="multi-ai-conversation" id="multi-ai-conversation" style="height: 600px; overflow-y: auto; padding: var(--space-4);">
                                    <div class="text-center text-muted p-5" id="conversation-empty-state">
                                        <div class="floating">
                                            <i class="bi bi-diagram-3" style="font-size: 48px; opacity: 0.3;"></i>
                                        </div>
                                        <h6 class="mt-3 mb-2">Multi-AI Orchestration</h6>
                                        <p class="mb-3">AI'lar birbirleriyle konuşmaya hazır</p>
                                        <small class="text-info">
                                            💡 "AI Orkestra Başlat" butonuna tıklayarak AI'ların birbirleriyle konuşmasını izleyin
                                        </small>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Control Panel -->
                    <div class="col-lg-4">
                        <!-- Conversation Settings -->
                        <div class="card-modern mb-4" data-animate="fadeInUp" data-delay="600">
                            <div class="card-header">
                                <h6 class="mb-0">
                                    <i class="bi bi-gear"></i>
                                    Orchestration Ayarları
                                </h6>
                            </div>
                            <div class="card-body">
                                <div class="mb-3">
                                    <label class="form-label text-sm">Maksimum Tur Sayısı</label>
                                    <input type="number" class="form-control focus-ring" id="orchestration-max-turns" value="5" min="1" max="15">
                                    <small class="text-muted">AI'lar arası konuşma tur sayısı</small>
                                </div>
                                
                                <div class="mb-3">
                                    <label class="form-label text-sm">Başlangıç Promptu</label>
                                    <textarea class="form-control focus-ring" id="orchestration-prompt" rows="4" placeholder="AI'ların konuşacağı konuyu yazın...">AI destekli bir proje geliştiriyoruz. Proje yöneticisi ve lead developer olarak birlikte bir plan oluşturalım.</textarea>
                                </div>

                                <div class="d-grid">
                                    <button class="btn-modern btn-primary" onclick="startCustomOrchestration()">
                                        <i class="bi bi-rocket"></i>
                                        Özel Konuşma Başlat
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- 🧠 AI Document Synthesizer Panel -->
                        <div class="card-modern mb-4" data-animate="fadeInUp" data-delay="700" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
                            <div class="card-header text-white">
                                <h6 class="mb-0">
                                    <i class="bi bi-file-earmark-text"></i>
                                    🧠 AI Document Synthesizer
                                    <span class="badge bg-light text-dark ms-2">Smart Professional Suite</span>
                                </h6>
                            </div>
                            <div class="card-body bg-white">
                                <div class="mb-3">
                                    <label class="form-label text-sm">Belge Türü:</label>
                                    <select id="document-type-selector" class="form-select focus-ring">
                                        <option value="meeting_summary">📋 Meeting Summary (Toplantı Özeti)</option>
                                        <option value="action_items">📋 Action Items (Eylem Planı)</option>
                                        <option value="decisions_log">✅ Decisions Log (Karar Defteri)</option>
                                    </select>
                                </div>
                                
                                <div class="d-grid gap-2">
                                    <button id="generate-document-btn" class="btn-modern btn-primary" disabled onclick="generateDocument()">
                                        <i class="bi bi-magic"></i>
                                        AI Belge Üret
                                    </button>
                                    <button id="view-documents-btn" class="btn-modern btn-outline-secondary btn-sm" onclick="showDocumentsModal()">
                                        <i class="bi bi-folder"></i>
                                        Belgeleri Görüntüle
                                    </button>
                                </div>
                                
                                <div id="document-generation-status" class="mt-3"></div>
                                
                                <hr class="my-3">
                                
                                <div class="document-stats">
                                    <h6 class="text-sm text-muted mb-2">
                                        <i class="bi bi-bar-chart"></i>
                                        Document İstatistikleri
                                    </h6>
                                    <div id="document-statistics" class="small">
                                        <div class="text-center text-muted">
                                            <i class="bi bi-hourglass-split"></i>
                                            Yükleniyor...
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Director Control Panel -->
                        <div class="card-modern" data-animate="fadeInUp" data-delay="800">
                            <div class="card-header">
                                <h6 class="mb-0">
                                    <i class="bi bi-person-gear"></i>
                                    Director Control
                                </h6>
                            </div>
                            <div class="card-body">
                                <div class="mb-3">
                                    <label class="form-label text-sm">Director Müdahale Mesajı</label>
                                    <textarea class="form-control focus-ring" id="director-intervention-text" rows="3" placeholder="Director olarak AI'lara yönlendirme mesajı..."></textarea>
                                </div>
                                
                                <div class="d-grid gap-2">
                                    <button class="btn-modern btn-warning" onclick="sendDirectorIntervention()" id="send-intervention-btn" disabled>
                                        <i class="bi bi-megaphone"></i>
                                        Müdahale Gönder
                                    </button>
                                    <button class="btn-modern btn-danger btn-sm" onclick="stopOrchestration()" id="stop-orchestration-btn" disabled>
                                        <i class="bi bi-stop-circle"></i>
                                        Orchestration Durdur
                                    </button>
                                </div>

                                <hr class="my-3">

                                <!-- Quick Actions -->
                                <div class="d-grid gap-2">
                                    <h6 class="text-sm text-muted mb-2">Hızlı Aksiyonlar</h6>
                                    <button class="btn-modern btn-info btn-sm" onclick="quickAction('summarize')">
                                        <i class="bi bi-file-text"></i>
                                        Özet İste
                                    </button>
                                    <button class="btn-modern btn-success btn-sm" onclick="quickAction('next_steps')">
                                        <i class="bi bi-arrow-right"></i>
                                        Sonraki Adımlar
                                    </button>
                                    <button class="btn-modern btn-primary btn-sm" onclick="quickAction('decision_needed')">
                                        <i class="bi bi-question-circle"></i>
                                        Karar Noktası
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Live Document Canvas Tab -->
            <div class="tab-pane fade" id="canvas" role="tabpanel" aria-labelledby="canvas-tab">
                <div class="d-flex justify-content-between align-items-center mb-4" data-animate="fadeInUp">
                    <div>
                        <h2 class="mb-2">🎨 Canlı Belge Tuvali</h2>
                        <p class="text-secondary mb-0">AI'lar ve insanlar için gerçek zamanlı işbirlikçi belge düzenleme</p>
                    </div>
                    <div class="d-flex gap-2">
                        <button class="btn-modern btn-success" onclick="createNewDocument()">
                            <i class="bi bi-file-plus"></i>
                            <span class="d-none d-sm-inline">Yeni Belge</span>
                        </button>
                        <button class="btn-modern btn-primary" onclick="showDocumentManager()">
                            <i class="bi bi-folder2-open"></i>
                            <span class="d-none d-sm-inline">Belge Yöneticisi</span>
                        </button>
                        <button class="btn-modern btn-info" onclick="showCanvasStatistics()">
                            <i class="bi bi-bar-chart"></i>
                            <span class="d-none d-sm-inline">İstatistikler</span>
                        </button>
                    </div>
                </div>

                <!-- Canvas Control Panel -->
                <div class="card-modern mb-4" data-animate="fadeInUp" data-delay="100">
                    <div class="card-header">
                        <h5 class="mb-0">
                            <i class="bi bi-gear-wide-connected"></i>
                            Canvas Kontrol Paneli
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="row g-3 align-items-end">
                            <div class="col-md-4">
                                <label class="form-label">Belge Türü</label>
                                <select class="form-select" id="canvas-document-type">
                                    <option value="markdown">📝 Markdown Belgesi</option>
                                    <option value="rich_text">🎨 Zengin Metin</option>
                                    <option value="collaborative">👥 İşbirlikçi Belge</option>
                                    <option value="code_notes">💻 Kod Notları</option>
                                </select>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">Belge Başlığı</label>
                                <input type="text" class="form-control" id="canvas-document-title" placeholder="Yeni Belge Başlığı...">
                            </div>
                            <div class="col-md-4">
                                <button class="btn-modern btn-success w-100" onclick="launchCanvasDocument()">
                                    <i class="bi bi-rocket-takeoff"></i>
                                    Canvas'ı Başlat
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Active Canvas Windows -->
                <div class="row g-4">
                    <!-- Canvas Windows Display -->
                    <div class="col-lg-8">
                        <div class="card-modern" data-animate="fadeInLeft" data-delay="200">
                            <div class="card-header d-flex justify-content-between align-items-center">
                                <h5 class="mb-0">
                                    <i class="bi bi-window-stack"></i>
                                    Aktif Canvas Pencereleri
                                </h5>
                                <span class="badge bg-primary" id="active-windows-count">0</span>
                            </div>
                            <div class="card-body" style="height: 400px; position: relative; overflow: hidden;">
                                <!-- Canvas Container -->
                                <div id="canvas-container" class="position-relative w-100 h-100">
                                    <div class="text-center text-muted h-100 d-flex align-items-center justify-content-center" id="canvas-empty-state">
                                        <div>
                                            <i class="bi bi-window-stack" style="font-size: 48px; opacity: 0.3;"></i>
                                            <p class="mt-3 mb-2">Henüz aktif canvas penceresi yok</p>
                                            <small>Yukarıdaki "Canvas'ı Başlat" butonuna tıklayın</small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Canvas Statistics & Controls -->
                    <div class="col-lg-4">
                        <!-- Real-time Statistics -->
                        <div class="card-modern mb-4" data-animate="fadeInRight" data-delay="200">
                            <div class="card-header">
                                <h6 class="mb-0">
                                    <i class="bi bi-graph-up"></i>
                                    Gerçek Zamanlı İstatistikler
                                </h6>
                            </div>
                            <div class="card-body">
                                <div class="row g-2 text-center">
                                    <div class="col-6">
                                        <div class="p-2 bg-light rounded">
                                            <strong class="text-primary" id="canvas-total-documents">0</strong><br>
                                            <small class="text-muted">Toplam Belge</small>
                                        </div>
                                    </div>
                                    <div class="col-6">
                                        <div class="p-2 bg-light rounded">
                                            <strong class="text-success" id="canvas-active-users">0</strong><br>
                                            <small class="text-muted">Aktif Kullanıcı</small>
                                        </div>
                                    </div>
                                    <div class="col-6">
                                        <div class="p-2 bg-light rounded">
                                            <strong class="text-warning" id="canvas-ai-edits">0</strong><br>
                                            <small class="text-muted">AI Düzenlemesi</small>
                                        </div>
                                    </div>
                                    <div class="col-6">
                                        <div class="p-2 bg-light rounded">
                                            <strong class="text-info" id="canvas-sync-status">●</strong><br>
                                            <small class="text-muted">Sync Durumu</small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Active Users & AI Presence -->
                        <div class="card-modern mb-4" data-animate="fadeInRight" data-delay="300">
                            <div class="card-header">
                                <h6 class="mb-0">
                                    <i class="bi bi-people"></i>
                                    Aktif Katılımcılar
                                </h6>
                            </div>
                            <div class="card-body">
                                <div id="canvas-participants">
                                    <div class="d-flex align-items-center mb-2">
                                        <span class="badge bg-secondary me-2">👤</span>
                                        <span class="text-sm">Sen (Ana Kullanıcı)</span>
                                    </div>
                                    <div class="d-flex align-items-center mb-2" id="ai-project-manager-presence" style="display: none;">
                                        <span class="badge bg-primary me-2">🤖</span>
                                        <span class="text-sm">AI Project Manager</span>
                                    </div>
                                    <div class="d-flex align-items-center mb-2" id="ai-developer-presence" style="display: none;">
                                        <span class="badge bg-success me-2">🤖</span>
                                        <span class="text-sm">AI Lead Developer</span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Canvas Actions -->
                        <div class="card-modern" data-animate="fadeInRight" data-delay="400">
                            <div class="card-header">
                                <h6 class="mb-0">
                                    <i class="bi bi-lightning-charge"></i>
                                    Hızlı Eylemler
                                </h6>
                            </div>
                            <div class="card-body">
                                <div class="d-grid gap-2">
                                    <button class="btn-modern btn-outline-primary btn-sm" onclick="minimizeAllWindows()">
                                        <i class="bi bi-dash-square"></i>
                                        Tümünü Küçült
                                    </button>
                                    <button class="btn-modern btn-outline-success btn-sm" onclick="maximizeAllWindows()">
                                        <i class="bi bi-arrows-fullscreen"></i>
                                        Tümünü Büyüt
                                    </button>
                                    <button class="btn-modern btn-outline-warning btn-sm" onclick="cascadeWindows()">
                                        <i class="bi bi-layers"></i>
                                        Kademeli Dizili
                                    </button>
                                    <button class="btn-modern btn-outline-danger btn-sm" onclick="closeAllWindows()">
                                        <i class="bi bi-x-square"></i>
                                        Tümünü Kapat
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- AI Integration Status -->
                <div class="card-modern mt-4" data-animate="fadeInUp" data-delay="500">
                    <div class="card-header">
                        <h5 class="mb-0">
                            <i class="bi bi-robot"></i>
                            AI Entegrasyon Durumu
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="row g-3">
                            <div class="col-md-4">
                                <div class="d-flex align-items-center">
                                    <span class="badge bg-success me-2">
                                        <i class="bi bi-check-circle"></i>
                                    </span>
                                    <div>
                                        <div class="text-sm font-weight-bold">Belge Durumu Yöneticisi</div>
                                        <small class="text-muted">Aktif ve hazır</small>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="d-flex align-items-center">
                                    <span class="badge bg-success me-2">
                                        <i class="bi bi-check-circle"></i>
                                    </span>
                                    <div>
                                        <div class="text-sm font-weight-bold">Gerçek Zamanlı Sync</div>
                                        <small class="text-muted">WebSocket bağlı</small>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="d-flex align-items-center">
                                    <span class="badge bg-success me-2">
                                        <i class="bi bi-check-circle"></i>
                                    </span>
                                    <div>
                                        <div class="text-sm font-weight-bold">AI Belge Entegrasyonu</div>
                                        <small class="text-muted">Hazır ve bekliyor</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Settings Tab -->
            <div class="tab-pane fade" id="settings" role="tabpanel" aria-labelledby="settings-tab">
                <div class="row">
                    <div class="col-md-6">
                        <div class="card-modern" data-animate="fadeInUp">
                            <div class="card-header">
                                <h5 class="mb-0">
                                    <i class="bi bi-people"></i>
                                    Rol Atamaları
                                </h5>
                            </div>
                            <div class="card-body">
                                <div id="role-assignments">
                                    <div class="loading-pulse">
                                        Rol atamaları yükleniyor...
                                </div>
                            </div>
                        </div>
                    </div>
                    </div>
                    
                    <div class="col-md-6">
                        <div class="card-modern" data-animate="fadeInUp" data-delay="200">
                            <div class="card-header">
                                <h5 class="mb-0">
                                    <i class="bi bi-speedometer2"></i>
                                    Sistem Durumu
                                </h5>
                            </div>
                            <div class="card-body">
                                <div id="system-status">
                                    <div class="loading-pulse">
                                        Sistem durumu kontrol ediliyor...
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- JavaScript -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.7.2/socket.io.js"></script>
    
    <!-- Rich Text Editor - Tiptap -->
    <script src="https://unpkg.com/@tiptap/core@2.1.13/dist/umd/index.js"></script>
    <script src="https://unpkg.com/@tiptap/starter-kit@2.1.13/dist/umd/index.js"></script>
    <script src="https://unpkg.com/@tiptap/extension-document@2.1.13/dist/umd/index.js"></script>
    <script src="https://unpkg.com/@tiptap/extension-text@2.1.13/dist/umd/index.js"></script>
    <script src="https://unpkg.com/@tiptap/extension-paragraph@2.1.13/dist/umd/index.js"></script>
    <script src="https://unpkg.com/@tiptap/extension-collaboration@2.1.13/dist/umd/index.js"></script>
    
    <script src="/static/js/theme-manager.js"></script>
    <script src="/static/js/animation-utils.js"></script>
    <script src="/static/js/main.js"></script>
    
    <script>
        // WebSocket connection for real-time AI orchestration
        let socket = null;
        let currentSessionId = null;
        let orchestrationActive = false;
        let messageCount = { pm: 0, dev: 0, boss: 0 };
        let orchestrationCosts = { pm: 0, dev: 0, boss: 0 };

        // Enhanced initialization
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize components
            initializeApp();
            
            // Initialize WebSocket
            initializeWebSocket();
            
            // Load initial data
            loadAnalyticsData();
            loadSystemStatus();
            loadRoleAssignments();
            loadInitialAICards(); // Başlangıçta AI kartlarını yükle
            loadDocumentStatistics(); // Document statistics'i yükle
            
            // Setup event listeners
            setupEventListeners();
        });

        function initializeApp() {
            console.log('🚀 AI Orchestrator v2.0 - Multi-AI Edition initialized');
            
            // Update connection status
            updateConnectionStatus(true);
            
            // Initialize participant states
            updateParticipantStatus('pm', 'Standby', false);
            updateParticipantStatus('dev', 'Standby', false);
            updateParticipantStatus('boss', 'Ready', false);
            
            // Focus management
            const activeTab = document.querySelector('.nav-link.active');
            if (activeTab) {
                activeTab.focus();
            }
        }

        function initializeWebSocket() {
            try {
                // Connect to WebSocket
                socket = io();
                console.log('🔌 WebSocket connecting...');
                
                updateWebSocketStatus('connecting');

                // Connection events
                socket.on('connect', function() {
                    console.log('✅ WebSocket connected');
                    updateWebSocketStatus('connected');
                });

                socket.on('disconnect', function() {
                    console.log('❌ WebSocket disconnected');
                    updateWebSocketStatus('disconnected');
                });

                // Multi-AI Conversation Events
                socket.on('conversation_started', function(data) {
                    console.log('🚀 AI Conversation Started:', data);
                    currentSessionId = data.session_id;
                    updateOrchestrationStatus('Aktif');
                    updateSessionInfo(data.session_id, data.max_turns);
                    clearConversationDisplay();
                    
                    // Update UI states
                    document.getElementById('start-multi-ai').disabled = true;
                    document.getElementById('pause-orchestration').disabled = false;
                    document.getElementById('send-intervention-btn').disabled = false;
                    document.getElementById('stop-orchestration-btn').disabled = false;
                    
                    // Update document generation UI
                    updateDocumentGenerationUI();
                    
                    addSystemMessage(`🎯 AI Orkestra başlatıldı! Maksimum ${data.max_turns} tur konuşma`);
                });

                socket.on('conversation_turn', function(data) {
                    console.log('🔄 Conversation Turn:', data);
                    updateTurnInfo(data.turn, data.phase);
                    
                    // Update participant thinking status
                    if (data.phase === 'pm_thinking') {
                        updateParticipantStatus('pm', 'Düşünüyor...', true, 'thinking');
                        updateParticipantStatus('dev', 'Bekliyor', true);
                    } else if (data.phase === 'ld_thinking') {
                        updateParticipantStatus('pm', 'Bekliyor', true);
                        updateParticipantStatus('dev', 'Düşünüyor...', true, 'thinking');
                    }
                });

                socket.on('conversation_message', function(data) {
                    console.log('💬 AI Message:', data);
                    addAIMessage(data);
                    
                    // Update participant status back to active
                    const role = data.speaker === 'project_manager' ? 'pm' : 'dev';
                    updateParticipantStatus(role, 'Aktif', true, 'online');
                    updateParticipantStats(role, data.usage);
                });

                socket.on('conversation_paused', function(data) {
                    console.log('⏸️ Conversation Paused:', data);
                    updateOrchestrationStatus('Durakladı');
                    
                    // Update UI states for paused conversation
                    document.getElementById('start-multi-ai').disabled = false;
                    document.getElementById('pause-orchestration').disabled = true;
                    document.getElementById('send-intervention-btn').disabled = false; // Müdahale hala mümkün
                    document.getElementById('stop-orchestration-btn').disabled = false;
                    
                    // Show continue button
                    showContinueButton(data.session_id, data.total_turns, data.can_continue);
                    
                    // Update participant statuses
                    updateParticipantStatus('pm', 'Bekliyor', true, 'online');
                    updateParticipantStatus('dev', 'Bekliyor', true, 'online');
                    
                    addSystemMessage(`⏸️ AI Orkestra durakladı! ${data.total_turns} tur tamamlandı. Devam ettirebilirsiniz.`);
                });

                socket.on('conversation_continued', function(data) {
                    console.log('🔄 Conversation Continued:', data);
                    updateOrchestrationStatus('Aktif');
                    
                    // Hide continue button
                    hideContinueButton();
                    
                    // Update UI states
                    document.getElementById('start-multi-ai').disabled = true;
                    document.getElementById('pause-orchestration').disabled = false;
                    document.getElementById('send-intervention-btn').disabled = false;
                    document.getElementById('stop-orchestration-btn').disabled = false;
                    
                    // Update participant statuses
                    updateParticipantStatus('pm', 'Aktif', true, 'online');
                    updateParticipantStatus('dev', 'Aktif', true, 'online');
                    
                    addSystemMessage(`🔄 AI Orkestra devam ediyor! ${data.additional_turns} ek tur eklendi.`);
                });

                socket.on('conversation_completed', function(data) {
                    console.log('✅ Conversation Completed:', data);
                    updateOrchestrationStatus('Tamamlandı');
                    
                    // Hide continue button
                    hideContinueButton();
                    
                    // Reset UI states
                    document.getElementById('start-multi-ai').disabled = false;
                    document.getElementById('pause-orchestration').disabled = true;
                    document.getElementById('send-intervention-btn').disabled = true;
                    document.getElementById('stop-orchestration-btn').disabled = true;
                    
                    // Update participant statuses
                    updateParticipantStatus('pm', 'Tamamlandı', true, 'online');
                    updateParticipantStatus('dev', 'Tamamlandı', true, 'online');
                    
                    addSystemMessage(`✅ AI Orkestra tamamlandı! Toplam ${data.total_turns} tur konuşma gerçekleşti.`);
                    
                    setTimeout(() => {
                        updateParticipantStatus('pm', 'Standby', false);
                        updateParticipantStatus('dev', 'Standby', false);
                        updateOrchestrationStatus('Beklemede');
                    }, 5000);
                });

                socket.on('intervention_applied', function(data) {
                    console.log('🔔 Director Intervention:', data);
                    addDirectorMessage(data.message);
                    updateParticipantStatus('boss', 'Müdahale Etti', true, 'online');
                    
                    setTimeout(() => {
                        updateParticipantStatus('boss', 'Ready', false);
                    }, 3000);
                });

                socket.on('conversation_error', function(data) {
                    console.error('❌ Conversation Error:', data);
                    updateOrchestrationStatus('Hata');
                    addSystemMessage(`❌ Hata: ${data.error}`, 'error');
                    
                    // Reset UI
                    resetOrchestrationUI();
                });

                // Analytics updates
                socket.on('analytics_update', function(data) {
                    console.log('📊 Analytics Update:', data);
                    updateAnalyticsDisplay(data);
                });

                // Document generation events
                socket.on('document_generated', function(data) {
                    console.log('📄 Document Generated:', data);
                    showDocumentGenerationSuccess(data);
                    loadDocumentStatistics(); // Stats'i güncelle
                });

                socket.on('document_generation_error', function(data) {
                    console.log('🚨 Document Generation Error:', data);
                    showDocumentGenerationError(data.error);
                });

            } catch (error) {
                console.error('WebSocket initialization error:', error);
                updateWebSocketStatus('error');
            }
        }

        function updateWebSocketStatus(status) {
            const wsStatus = document.getElementById('ws-status');
            const wsBadge = document.getElementById('ws-connection-badge');
            const wsIcon = document.getElementById('ws-icon');
            
            switch (status) {
                case 'connected':
                    wsStatus.textContent = 'Bağlı';
                    wsBadge.className = 'badge connected';
                    wsIcon.className = 'bi bi-wifi';
                    break;
                case 'connecting':
                    wsStatus.textContent = 'Bağlanıyor...';
                    wsBadge.className = 'badge connecting';
                    wsIcon.className = 'bi bi-wifi';
                    break;
                case 'disconnected':
                    wsStatus.textContent = 'Bağlantı Kesildi';
                    wsBadge.className = 'badge disconnected';
                    wsIcon.className = 'bi bi-wifi-off';
                    break;
                case 'error':
                    wsStatus.textContent = 'Hata';
                    wsBadge.className = 'badge disconnected';
                    wsIcon.className = 'bi bi-exclamation-triangle';
                    break;
            }
        }

        function updateOrchestrationStatus(status) {
            document.getElementById('orchestration-status').textContent = status;
            orchestrationActive = (status === 'Aktif');
        }

        function updateSessionInfo(sessionId, maxTurns) {
            document.getElementById('session-id').textContent = sessionId.substring(0, 8);
            document.getElementById('max-turn').textContent = maxTurns;
        }

        function updateTurnInfo(currentTurn, phase) {
            document.getElementById('current-turn').textContent = currentTurn;
        }

        function updateParticipantStatus(participant, status, online = false, indicatorType = 'offline') {
            const statusEl = document.getElementById(`${participant}-status`);
            const indicatorEl = document.getElementById(`${participant}-indicator`);
            
            if (statusEl) statusEl.textContent = status;
            if (indicatorEl) {
                indicatorEl.className = `participant-indicator ${indicatorType}`;
            }
        }

        function updateParticipantStats(participant, usage) {
            messageCount[participant]++;
            if (usage && usage.total_cost) {
                orchestrationCosts[participant] += parseFloat(usage.total_cost);
            }
            
            // Update UI
            const messageCountEl = document.getElementById(`${participant}-message-count`);
            const costEl = document.getElementById(`${participant}-cost`);
            
            if (messageCountEl) messageCountEl.textContent = messageCount[participant];
            if (costEl) costEl.textContent = orchestrationCosts[participant].toFixed(4);
        }

        function clearConversationDisplay() {
            const conversationContainer = document.getElementById('multi-ai-conversation');
            const emptyState = document.getElementById('conversation-empty-state');
            
            if (emptyState) {
                emptyState.style.display = 'none';
            }
            
            // Clear previous messages except empty state
            const messages = conversationContainer.querySelectorAll('.ai-conversation-message, .system-message, .director-message');
            messages.forEach(msg => msg.remove());
        }

        function addAIMessage(data) {
            const conversationContainer = document.getElementById('multi-ai-conversation');
            const roleClass = data.speaker === 'project_manager' ? 'pm' : 'dev';
            const roleIcon = data.speaker === 'project_manager' ? '👔' : '👨‍💻';
            
            const messageEl = document.createElement('div');
            messageEl.className = `ai-conversation-message ${roleClass}`;
            messageEl.innerHTML = `
                <div class="ai-message-turn">${data.turn}</div>
                <div class="ai-message-header">
                    <span class="ai-message-speaker">${roleIcon} ${data.speaker_name}</span>
                    <span class="ai-message-meta">
                        ${data.model} • ${new Date(data.timestamp).toLocaleTimeString()}
                        ${data.usage ? ` • $${parseFloat(data.usage.total_cost || 0).toFixed(4)}` : ''}
                    </span>
                </div>
                <div class="ai-message-content">${formatMessageContent(data.message)}</div>
            `;
            
            conversationContainer.appendChild(messageEl);
            conversationContainer.scrollTop = conversationContainer.scrollHeight;
        }

        function addSystemMessage(message, type = 'info') {
            const conversationContainer = document.getElementById('multi-ai-conversation');
            
            const messageEl = document.createElement('div');
            messageEl.className = `system-message text-center my-3`;
            messageEl.innerHTML = `
                <div class="badge bg-${type === 'error' ? 'danger' : 'primary'} px-3 py-2">
                    ${message}
                </div>
            `;
            
            conversationContainer.appendChild(messageEl);
            conversationContainer.scrollTop = conversationContainer.scrollHeight;
        }

        function addDirectorMessage(message) {
            const conversationContainer = document.getElementById('multi-ai-conversation');
            
            const messageEl = document.createElement('div');
            messageEl.className = 'ai-conversation-message director';
            messageEl.innerHTML = `
                <div class="ai-message-header">
                    <span class="ai-message-speaker">👑 Director Müdahale</span>
                    <span class="ai-message-meta">${new Date().toLocaleTimeString()}</span>
                </div>
                <div class="ai-message-content"><strong>🔔 ${message}</strong></div>
            `;
            
            conversationContainer.appendChild(messageEl);
            conversationContainer.scrollTop = conversationContainer.scrollHeight;
        }

        function formatMessageContent(content) {
            // Basic markdown-like formatting
            return content
                .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                .replace(/\*(.*?)\*/g, '<em>$1</em>')
                .replace(/\n/g, '<br>');
        }

        function resetOrchestrationUI() {
            document.getElementById('start-multi-ai').disabled = false;
            document.getElementById('pause-orchestration').disabled = true;
            document.getElementById('send-intervention-btn').disabled = true;
            document.getElementById('stop-orchestration-btn').disabled = true;
            
            // Continue butonunu gizle
            hideContinueButton();
            
            updateParticipantStatus('pm', 'Standby', false);
            updateParticipantStatus('dev', 'Standby', false);
            updateParticipantStatus('boss', 'Ready', false);
            updateOrchestrationStatus('Beklemede');
            
            currentSessionId = null;
            orchestrationActive = false;
            
            // Update document generation UI
            updateDocumentGenerationUI();
        }

        // Multi-AI Orchestration Functions
        function startMultiAIOrchestration() {
            const maxTurns = document.getElementById('orchestration-max-turns').value || 5;
            const prompt = document.getElementById('orchestration-prompt').value || 'AI destekli bir proje geliştiriyoruz. Proje yöneticisi ve lead developer olarak birlikte bir plan oluşturalım.';
            
            if (!socket || !socket.connected) {
                alert('WebSocket bağlantısı yok! Sayfa yenileyin.');
                return;
            }
            
            console.log('🚀 Starting Multi-AI Orchestration:', { maxTurns, prompt });
            
            fetch('/api/ai/conversation', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    prompt: prompt,
                    max_turns: parseInt(maxTurns)
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'started') {
                    console.log('✅ AI Orchestration started successfully');
                } else {
                    console.error('❌ Failed to start orchestration:', data);
                    alert('AI Orkestra başlatılamadı: ' + (data.error || 'Bilinmeyen hata'));
                }
            })
            .catch(error => {
                console.error('❌ Orchestration start error:', error);
                alert('Bağlantı hatası: ' + error.message);
            });
        }

        function startCustomOrchestration() {
            startMultiAIOrchestration();
        }

        function pauseOrchestration() {
            // TODO: Implement pause functionality in backend
            console.log('⏸️ Pause not implemented yet');
        }

        function stopOrchestration() {
            // TODO: Implement stop functionality in backend
            resetOrchestrationUI();
            addSystemMessage('⏹️ Orchestration manuel olarak durduruldu', 'warning');
        }

        function clearOrchestration() {
            const conversationContainer = document.getElementById('multi-ai-conversation');
            const emptyState = document.getElementById('conversation-empty-state');
            
            // Clear all messages
            conversationContainer.innerHTML = `
                <div class="text-center text-muted p-5" id="conversation-empty-state">
                    <div class="floating">
                        <i class="bi bi-diagram-3" style="font-size: 48px; opacity: 0.3;"></i>
                    </div>
                    <h6 class="mt-3 mb-2">Multi-AI Orchestration</h6>
                    <p class="mb-3">AI'lar birbirleriyle konuşmaya hazır</p>
                    <small class="text-info">
                        💡 "AI Orkestra Başlat" butonuna tıklayarak AI'ların birbirleriyle konuşmasını izleyin
                    </small>
                </div>
            `;
            
            // Reset stats
            messageCount = { pm: 0, dev: 0, boss: 0 };
            orchestrationCosts = { pm: 0, dev: 0, boss: 0 };
            updateParticipantStats('pm', null);
            updateParticipantStats('dev', null);
            updateParticipantStats('boss', null);
        }

        function sendDirectorIntervention() {
            const message = document.getElementById('director-intervention-text').value;
            if (!message.trim()) {
                alert('Müdahale mesajı yazın!');
                return;
            }
            
            if (!currentSessionId) {
                alert('Aktif bir konuşma yok!');
                return;
            }
            
            fetch('/api/ai/intervention', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    session_id: currentSessionId,
                    message: message
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'received') {
                    document.getElementById('director-intervention-text').value = '';
                    console.log('✅ Director intervention sent');
                } else {
                    alert('Müdahale gönderilemedi: ' + (data.error || 'Bilinmeyen hata'));
                }
            })
            .catch(error => {
                console.error('❌ Intervention error:', error);
                alert('Bağlantı hatası: ' + error.message);
            });
        }

        function showContinueButton(sessionId, completedTurns, canContinue) {
            if (!canContinue) return;
            
            const conversationContainer = document.getElementById('multi-ai-conversation');
            
            // Continue button control paneli ekle
            const continueControlHtml = `
                <div id="continue-conversation-control" class="card-modern mt-4" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
                    <div class="card-body text-center">
                        <h6 class="mb-3">
                            <i class="bi bi-pause-circle"></i> 
                            Konuşma Durakladı
                        </h6>
                        <p class="mb-3">
                            <strong>${completedTurns} tur</strong> tamamlandı. 
                            Aynı context ile devam edebilirsiniz.
                        </p>
                        <div class="row g-2">
                            <div class="col-md-8">
                                <input type="number" class="form-control" id="continue-turns" 
                                       value="3" min="1" max="15" 
                                       placeholder="Ek tur sayısı">
                            </div>
                            <div class="col-md-4">
                                <button class="btn btn-light w-100" onclick="continueConversation()">
                                    <i class="bi bi-play-circle"></i> Devam Et
                                </button>
                            </div>
                        </div>
                        <div class="mt-2">
                            <small>
                                <button class="btn btn-sm btn-outline-light me-2" onclick="continueConversation(5)">
                                    +5 Tur
                                </button>
                                <button class="btn btn-sm btn-outline-light me-2" onclick="continueConversation(10)">
                                    +10 Tur
                                </button>
                                <button class="btn btn-sm btn-outline-danger" onclick="endConversationPermanently()">
                                    <i class="bi bi-stop-circle"></i> Sonlandır
                                </button>
                            </small>
                        </div>
                    </div>
                </div>
            `;
            
            conversationContainer.insertAdjacentHTML('beforeend', continueControlHtml);
            conversationContainer.scrollTop = conversationContainer.scrollHeight;
        }

        function hideContinueButton() {
            const continueControl = document.getElementById('continue-conversation-control');
            if (continueControl) {
                continueControl.remove();
            }
        }

        function continueConversation(additionalTurns = null) {
            if (!currentSessionId) {
                alert('Devam ettirilebilir konuşma bulunamadı!');
                return;
            }
            
            const turns = additionalTurns || document.getElementById('continue-turns')?.value || 3;
            
            console.log(`🔄 Continuing conversation ${currentSessionId} with ${turns} additional turns`);
            
            fetch('/api/ai/conversation/continue', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    session_id: currentSessionId,
                    additional_turns: parseInt(turns)
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'continuing') {
                    console.log('✅ Conversation continuing successfully');
                    hideContinueButton();
                } else {
                    console.error('❌ Failed to continue conversation:', data);
                    alert('Konuşma devam ettirilemedi: ' + (data.error || 'Bilinmeyen hata'));
                }
            })
            .catch(error => {
                console.error('❌ Continue conversation error:', error);
                alert('Bağlantı hatası: ' + error.message);
            });
        }

        function endConversationPermanently() {
            if (!currentSessionId) {
                alert('Sonlandırılacak konuşma bulunamadı!');
                return;
            }
            
            if (!confirm('Konuşmayı kalıcı olarak sonlandırmak istediğinizden emin misiniz?')) {
                return;
            }
            
            fetch(`/api/ai/conversation/${currentSessionId}/end`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'ended') {
                    console.log('✅ Conversation ended permanently');
                    hideContinueButton();
                    resetOrchestrationUI();
                    addSystemMessage('⏹️ Konuşma kalıcı olarak sonlandırıldı', 'warning');
                } else {
                    alert('Konuşma sonlandırılamadı: ' + (data.error || 'Bilinmeyen hata'));
                }
            })
            .catch(error => {
                console.error('❌ End conversation error:', error);
                alert('Bağlantı hatası: ' + error.message);
            });
        }

        function showDirectorControl() {
            // Scroll to director control panel
            document.querySelector('#director-intervention-text').focus();
        }

        function quickAction(action) {
            let message = '';
            switch (action) {
                case 'summarize':
                    message = 'Lütfen şu ana kadar yapılan konuşmayı özetleyin ve ana noktaları belirtin.';
                    break;
                case 'next_steps':
                    message = 'Sonraki adımları belirleyin ve öncelikli görevleri tanımlayın.';
                    break;
                case 'decision_needed':
                    message = 'Karar alınması gereken konuları listeleyin ve önerilerinizi sunun.';
                    break;
            }
            
            document.getElementById('director-intervention-text').value = message;
            sendDirectorIntervention();
        }

        function updateConnectionStatus(isConnected) {
            const indicator = document.getElementById('status-indicator');
            const status = document.getElementById('connection-status');
            
            if (isConnected) {
                indicator.className = 'status-dot online';
                status.textContent = 'Bağlı';
            } else {
                indicator.className = 'status-dot offline';
                status.textContent = 'Bağlantı Kesildi';
            }
        }

        function scrollToSection(sectionId) {
            const tabButton = document.querySelector(`#${sectionId}-tab`);
            if (tabButton) {
                tabButton.click();
                
                // Smooth scroll to top of content
                setTimeout(() => {
                    window.scrollTo({
                        top: 100,
                        behavior: 'smooth'
                    });
                }, 100);
            }
        }

        function loadAnalyticsData() {
            // Simulate loading analytics data
            setTimeout(() => {
                if (window.animationUtils) {
                    window.animationUtils.countUp(
                        document.getElementById('total-requests'), 
                        0, 156, 2000
                    );
                    
                    window.animationUtils.typeText(
                        document.getElementById('cost-change'), 
                        '+12% bu ay', 30
                    );
                }
            }, 1000);
        }

        function setupEventListeners() {
            // Chat form for analytics panel
            const chatForm = document.getElementById('chat-form');
            if (chatForm) {
                chatForm.addEventListener('submit', function(e) {
                    e.preventDefault();
                    sendChatMessage();
                });
            }
            
            // Enter key handling for director intervention
            const interventionText = document.getElementById('director-intervention-text');
            if (interventionText) {
                interventionText.addEventListener('keydown', function(e) {
                    if (e.key === 'Enter' && (e.ctrlKey || e.metaKey)) {
                        e.preventDefault();
                        sendDirectorIntervention();
                    }
                });
            }
        }

        function loadRoleAssignments() {
            fetch('/api/keys')
                .then(response => response.json())
                .then(data => {
                    if (data.adapters) {
                        // Update participant models based on role assignments
                        Object.keys(data.adapters).forEach(adapterId => {
                            const adapter = data.adapters[adapterId];
                            if (adapter.role) {
                                const participant = adapter.role === 'project_manager' ? 'pm' : 
                                                 adapter.role === 'lead_developer' ? 'dev' : 
                                                 adapter.role === 'boss' ? 'boss' : null;
                                if (participant) {
                                    const modelEl = document.getElementById(`${participant}-model`);
                                    if (modelEl) {
                                        modelEl.textContent = adapterId;
                                    }
                                }
                            }
                        });
                    }
                })
                .catch(error => {
                    console.error('Error loading role assignments:', error);
                });
        }

        function loadInitialAICards() {
            // Fetch analytics data to populate AI cards
            fetch('/api/analytics')
                .then(response => response.json())
                .then(data => {
                    if (data.adapters) {
                        console.log('📊 Loading initial AI cards:', data.adapters);
                        updateAICards(data.adapters);
                    } else {
                        // Show initial empty state with role assignments
                        fetch('/api/keys')
                            .then(response => response.json())
                            .then(keyData => {
                                if (keyData.adapters) {
                                    // Create mock analytics data from key data
                                    const mockAnalytics = {};
                                    Object.keys(keyData.adapters).forEach(adapterId => {
                                        const adapter = keyData.adapters[adapterId];
                                        mockAnalytics[adapterId] = {
                                            role: adapter.role,
                                            type: adapter.type || 'gemini',
                                            model: adapter.model || adapterId,
                                            is_available: true,
                                            stats: {
                                                total_requests: 0,
                                                total_cost: 0,
                                                total_tokens: 0
                                            }
                                        };
                                    });
                                    console.log('🔑 Creating initial AI cards from key data:', mockAnalytics);
                                    updateAICards(mockAnalytics);
                                }
                            })
                            .catch(error => {
                                console.error('Error loading initial cards from keys:', error);
                            });
                    }
                })
                .catch(error => {
                    console.error('Error loading initial analytics:', error);
                    // Show empty state on error
                    updateAICards({});
                });
        }

        function updateAnalyticsDisplay(data) {
            try {
                // Update summary metrics
                if (data.summary) {
                    const elements = {
                        'total-cost': `$${data.summary.total_cost.toFixed(4)}`,
                        'total-requests': data.summary.total_requests,
                        'success-rate': `${data.summary.success_rate}%`,
                        'avg-response': `${data.summary.avg_response_time}s`,
                        'total-tokens': data.summary.total_tokens,
                        'error-count': `${data.summary.total_errors} hata`
                    };
                    
                    Object.keys(elements).forEach(id => {
                        const element = document.getElementById(id);
                        if (element) {
                            element.textContent = elements[id];
                        }
                    });
                }

                // Update AI cards
                if (data.adapters) {
                    updateAICards(data.adapters);
                }

                // Update token usage
                if (data.token_usage) {
                    updateTokenUsage(data.token_usage);
                }
            } catch (error) {
                console.error('Error updating analytics display:', error);
            }
        }

        function updateAICards(adapters) {
            const container = document.getElementById('ai-cards-container');
            if (!container) return;
            
            container.innerHTML = '';
            
            if (!adapters || Object.keys(adapters).length === 0) {
                // Show empty state
                container.innerHTML = `
                    <div class="col-12">
                        <div class="ai-cards-empty-state">
                            <i class="bi bi-robot"></i>
                            <h6 class="mb-2">AI Adapterleri Yükleniyor...</h6>
                            <p class="text-sm">Analytics verisi alınıyor...</p>
                        </div>
                    </div>
                `;
                return;
            }
            
            Object.keys(adapters).forEach((adapterId, index) => {
                const adapter = adapters[adapterId];
                const roleIcon = adapter.role === 'project_manager' ? '👔' : 
                               adapter.role === 'lead_developer' ? '👨‍💻' : 
                               adapter.role === 'boss' ? '👑' : '🤖';
                
                const roleName = adapter.role === 'project_manager' ? 'Project Manager' :
                               adapter.role === 'lead_developer' ? 'Lead Developer' :
                               adapter.role === 'boss' ? 'Director' : 'Unassigned';
                
                // Enhanced status calculation using real performance data
                let statusColor = 'success';
                let statusText = 'active';
                
                if (adapter.real_performance) {
                    if (!adapter.real_performance.is_available) {
                        statusColor = 'warning';
                        statusText = 'standby';
                    } else if (adapter.real_performance.status === 'error') {
                        statusColor = 'danger';
                        statusText = 'error';
                    }
                } else if (!adapter.is_available) {
                    statusColor = 'warning';
                    statusText = 'standby';
                }
                
                // Enhanced model name formatting
                let displayModel = adapter.model || adapterId;
                if (displayModel.includes('gemini')) {
                    if (displayModel.includes('2.0-flash')) {
                        displayModel = 'Gemini 2.0 Flash';
                    } else if (displayModel.includes('2.5-flash')) {
                        displayModel = 'Gemini 2.5 Flash';
                    } else if (displayModel.includes('2.5-pro')) {
                        displayModel = 'Gemini 2.5 Pro';
                    } else if (displayModel.includes('pro')) {
                        displayModel = 'Gemini Pro';
                    } else {
                        displayModel = 'Gemini Flash';
                    }
                } else if (displayModel.includes('gpt')) {
                    displayModel = displayModel.toUpperCase().replace('-', ' ');
                }
                
                // Enhanced cost calculation from real performance data
                let totalCost = 0;
                if (adapter.real_performance && adapter.real_performance.total_cost !== undefined) {
                    totalCost = adapter.real_performance.total_cost;
                } else if (adapter.stats && adapter.stats.total_cost !== undefined) {
                    totalCost = adapter.stats.total_cost;
                }
                
                const formattedCost = totalCost === 0 ? '$0.000' : 
                    totalCost >= 0.01 ? `$${totalCost.toFixed(3)}` : `$${totalCost.toFixed(4)}`;
                
                // Response time from real performance data
                let responseTime = '0.0s';
                if (adapter.real_performance && adapter.real_performance.avg_response_time !== undefined) {
                    responseTime = `${adapter.real_performance.avg_response_time}s`;
                } else if (adapter.stats && adapter.stats.avg_response_time !== undefined) {
                    responseTime = `${adapter.stats.avg_response_time}s`;
                }
                
                // Total requests from real performance data
                let totalRequests = 0;
                if (adapter.real_performance && adapter.real_performance.total_requests !== undefined) {
                    totalRequests = adapter.real_performance.total_requests;
                } else if (adapter.stats && adapter.stats.total_requests !== undefined) {
                    totalRequests = adapter.stats.total_requests;
                }
                
                // Total tokens from real performance data
                let totalTokens = 0;
                if (adapter.real_performance && adapter.real_performance.total_tokens !== undefined) {
                    totalTokens = adapter.real_performance.total_tokens;
                } else if (adapter.stats && adapter.stats.total_tokens !== undefined) {
                    totalTokens = adapter.stats.total_tokens;
                }
                
                const cardHtml = `
                    <div class="col-lg-6 col-xl-12 mb-3" style="animation-delay: ${index * 100}ms">
                        <div class="ai-performance-card" data-role="${adapter.role || 'unassigned'}">
                            <div class="d-flex align-items-center mb-2">
                                <div class="ai-icon">${roleIcon}</div>
                                <div class="flex-grow-1">
                                    <div class="ai-name">${roleName}</div>
                                    <div class="text-muted text-sm">
                                        <i class="bi bi-cpu"></i> ${displayModel}
                                    </div>
                                </div>
                                <div class="ms-auto">
                                    <span class="badge bg-${statusColor}">
                                        <i class="bi bi-circle-fill me-1" style="font-size: 8px;"></i>
                                        ${statusText}
                                    </span>
                                </div>
                            </div>
                            <div class="stats-row">
                                <div class="stat">
                                    <div class="stat-value">${totalRequests}</div>
                                    <div class="stat-label">
                                        <i class="bi bi-arrow-repeat"></i> İstek
                                    </div>
                                </div>
                                <div class="stat">
                                    <div class="stat-value">${formattedCost}</div>
                                    <div class="stat-label">
                                        <i class="bi bi-currency-dollar"></i> Maliyet
                                    </div>
                                </div>
                                <div class="stat">
                                    <div class="stat-value">${totalTokens.toLocaleString()}</div>
                                    <div class="stat-label">
                                        <i class="bi bi-type"></i> Token
                                    </div>
                                </div>
                            </div>
                            <div class="performance-details mt-2 pt-2" style="border-top: 1px solid var(--border-subtle);">
                                <div class="d-flex justify-content-between align-items-center">
                                    <small class="text-muted">
                                        <i class="bi bi-speedometer2"></i> Ortalama Yanıt: ${responseTime}
                                    </small>
                                    ${adapter.real_performance && adapter.real_performance.success_rate !== undefined ? 
                                        `<small class="text-muted">
                                            <i class="bi bi-check-circle"></i> Başarı: ${Math.round(adapter.real_performance.success_rate)}%
                                        </small>` : ''
                                    }
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                
                container.innerHTML += cardHtml;
            });
            
            // Add loading animation to new cards
            const cards = container.querySelectorAll('.ai-performance-card');
            cards.forEach((card, index) => {
                setTimeout(() => {
                    card.style.opacity = '0';
                    card.style.transform = 'translateY(20px)';
                    card.style.transition = 'all 0.3s ease-out';
                    
                    setTimeout(() => {
                        card.style.opacity = '1';
                        card.style.transform = 'translateY(0)';
                    }, 50);
                }, index * 100);
            });
        }

        function updateTokenUsage(tokenUsage) {
            const totalTokens = tokenUsage.total || 0;
            const inputTokens = tokenUsage.input || 0;
            const outputTokens = tokenUsage.output || 0;
            
            document.getElementById('total-tokens').textContent = totalTokens;
            document.getElementById('input-tokens').textContent = inputTokens;
            document.getElementById('output-tokens').textContent = outputTokens;
            
            if (totalTokens > 0) {
                const inputPercentage = (inputTokens / totalTokens * 100).toFixed(1);
                const outputPercentage = (outputTokens / totalTokens * 100).toFixed(1);
                
                document.getElementById('input-percentage').textContent = inputPercentage + '%';
                document.getElementById('output-percentage').textContent = outputPercentage + '%';
                
                document.getElementById('progress-input').style.width = inputPercentage + '%';
                document.getElementById('progress-output').style.width = outputPercentage + '%';
            }
        }

        function sendChatMessage() {
            const input = document.getElementById('chat-input');
            const message = input.value.trim();
            
            if (!message) return;
            
            // Add user message to chat
            addUserMessage(message);
            input.value = '';
            
            // Send to AI
            fetch('/api/ai/send_message', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    message: message,
                    role: 'project_manager'
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.response) {
                    addAIResponse(data.response, data.model);
                } else {
                    addErrorMessage(data.error || 'Yanıt alınamadı');
                }
            })
            .catch(error => {
                console.error('Chat error:', error);
                addErrorMessage('Bağlantı hatası: ' + error.message);
            });
        }

        function addUserMessage(message) {
            const chatMessages = document.getElementById('chat-messages');
            const messageEl = document.createElement('div');
            messageEl.className = 'message-bubble user mb-3';
            messageEl.innerHTML = `
                <div class="message-content">${message}</div>
                <div class="message-time">${new Date().toLocaleTimeString()}</div>
            `;
            
            // Remove empty state if present
            const emptyState = chatMessages.querySelector('.text-center');
            if (emptyState) {
                emptyState.remove();
            }
            
            chatMessages.appendChild(messageEl);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        function addAIResponse(response, model) {
            const chatMessages = document.getElementById('chat-messages');
            const messageEl = document.createElement('div');
            messageEl.className = 'message-bubble assistant mb-3';
            messageEl.innerHTML = `
                <div class="message-content">${formatMessageContent(response)}</div>
                <div class="message-time">${model} • ${new Date().toLocaleTimeString()}</div>
            `;
            
            chatMessages.appendChild(messageEl);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        function addErrorMessage(error) {
            const chatMessages = document.getElementById('chat-messages');
            const messageEl = document.createElement('div');
            messageEl.className = 'message-bubble error mb-3';
            messageEl.innerHTML = `
                <div class="message-content">❌ ${error}</div>
                <div class="message-time">${new Date().toLocaleTimeString()}</div>
            `;
            
            chatMessages.appendChild(messageEl);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        function loadSystemStatus() {
            const statusContainer = document.getElementById('system-status');
            
            // Show skeleton loading
            if (window.animationUtils) {
                window.animationUtils.showSkeleton(statusContainer, 4);
            }
            
            // Simulate API call
            setTimeout(() => {
                const statusHtml = `
                    <div class="d-flex align-items-center justify-content-between mb-3">
                        <span class="text-sm">Gemini API</span>
                        <span class="badge bg-success">Aktif</span>
                </div>
                    <div class="d-flex align-items-center justify-content-between mb-3">
                        <span class="text-sm">OpenAI API</span>
                        <span class="badge bg-warning">Sınırlı</span>
                            </div>
                    <div class="d-flex align-items-center justify-content-between mb-3">
                        <span class="text-sm">Sistem Sağlığı</span>
                        <span class="badge bg-success">Mükemmel</span>
                            </div>
                    <div class="d-flex align-items-center justify-content-between">
                        <span class="text-sm">Uptime</span>
                        <span class="text-sm font-medium">99.9%</span>
                        </div>
                `;
                
                if (window.animationUtils) {
                    window.animationUtils.hideSkeleton(statusContainer, statusHtml);
                } else {
                    statusContainer.innerHTML = statusHtml;
                }
            }, 2000);
        }

        function loadRoleAssignments() {
            const container = document.getElementById('role-assignments');
            
            // Show skeleton loading
            if (window.animationUtils) {
                window.animationUtils.showSkeleton(container, 5);
            }
            
            // Simulate API call
            setTimeout(() => {
                const rolesHtml = `
                    <div class="specialist-card pm mb-3">
                        <div class="d-flex align-items-center">
                            <div class="p-2 rounded bg-primary-100 text-primary-600 me-3">
                                <i class="bi bi-clipboard-check"></i>
                                </div>
                            <div>
                                <div class="font-medium">Proje Yöneticisi</div>
                                <div class="text-sm text-secondary">Gemini Pro</div>
                            </div>
                        </div>
                    </div>
                    <div class="specialist-card dev mb-3">
                        <div class="d-flex align-items-center">
                            <div class="p-2 rounded bg-success-100 text-success-600 me-3">
                                <i class="bi bi-code-slash"></i>
                </div>
                            <div>
                                <div class="font-medium">Lead Developer</div>
                                <div class="text-sm text-secondary">Gemini Flash</div>
                </div>
            </div>
        </div>
                `;
                
                if (window.animationUtils) {
                    window.animationUtils.hideSkeleton(container, rolesHtml);
                } else {
                    container.innerHTML = rolesHtml;
                }
            }, 1500);
        }

        function setupEventListeners() {
            // Tab change animations
            document.querySelectorAll('[data-bs-toggle="tab"]').forEach(tab => {
                tab.addEventListener('shown.bs.tab', function(e) {
                    const targetPanel = document.querySelector(e.target.getAttribute('data-bs-target'));
                    const animatedElements = targetPanel.querySelectorAll('[data-animate]');
                    
                    if (window.animationUtils) {
                        window.animationUtils.staggerAnimation(animatedElements, 'bounce-in', 100);
                    }
                });
            });

            // Form submissions
            document.getElementById('chat-form')?.addEventListener('submit', function(e) {
                e.preventDefault();
                const input = document.getElementById('chat-input');
                const message = input.value.trim();
                
                if (message) {
                    // Show user message and loading
                    addChatMessage(message, 'user');
                    addChatMessage('⏳ Yanıt bekleniyor...', 'system');
                    input.value = '';
                    
                    // Send real API request
                    fetch('/api/ai/send_message', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            message: message,
                            role: 'project_manager' // Default role
                        })
                    })
                    .then(response => {
                        console.log('📤 Chat response status:', response.status);
                        if (!response.ok) {
                            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                        }
                        return response.json();
                    })
                    .then(data => {
                        console.log('📥 Chat response data:', data);
                        
                        // Remove loading message
                        const messages = document.getElementById('chat-messages');
                        const lastMessage = messages.lastElementChild;
                        if (lastMessage && lastMessage.textContent.includes('⏳')) {
                            messages.removeChild(lastMessage);
                        }
                        
                        if (data.success && data.response) {
                            addChatMessage(data.response, 'assistant');
                        } else if (data.status === 'processing') {
                            // AI still processing - wait for response
                            const messages = document.getElementById('chat-messages');
                            const lastMessage = messages.lastElementChild;
                            if (lastMessage && lastMessage.textContent.includes('⏳')) {
                                lastMessage.textContent = `🤖 ${data.role_id} işleniyor...`;
                            }
                            
                            // Poll for result after 2 seconds
                            setTimeout(() => {
                                addChatMessage('⚠️ Yanıt alma süresi aşıldı. Lütfen tekrar deneyin.', 'error');
                                // Remove the processing message
                                const messages = document.getElementById('chat-messages');
                                const lastMessage = messages.lastElementChild;
                                if (lastMessage && lastMessage.textContent.includes('işleniyor')) {
                                    messages.removeChild(lastMessage.previousElementSibling);
                                }
                            }, 10000); // 10 second timeout
                        } else if (data.error) {
                            addChatMessage('❌ Hata: ' + data.error, 'error');
                        } else {
                            console.log('🔍 Full response data:', JSON.stringify(data, null, 2));
                            addChatMessage('❌ Beklenmeyen yanıt formatı: ' + JSON.stringify(data), 'error');
                        }
                    })
                    .catch(error => {
                        console.error('❌ Message API error:', error);
                        
                        // Remove loading message
                        const messages = document.getElementById('chat-messages');
                        const lastMessage = messages.lastElementChild;
                        if (lastMessage && lastMessage.textContent.includes('⏳')) {
                            messages.removeChild(lastMessage);
                        }
                        
                        addChatMessage('❌ Bağlantı hatası: ' + error.message, 'error');
                    });
                }
            });
        }

        function addChatMessage(message, type) {
            const messagesContainer = document.getElementById('chat-messages');
            
            // Clear empty state
            if (messagesContainer.querySelector('.text-center')) {
                messagesContainer.innerHTML = '';
            }
            
            const messageElement = document.createElement('div');
            messageElement.className = `message-bubble ${type} mb-3`;
            
            // Add appropriate styling based on type
            if (type === 'user') {
                messageElement.style.background = 'var(--primary-500)';
                messageElement.style.color = 'white';
                messageElement.style.marginLeft = 'auto';
                messageElement.style.marginRight = '0';
                messageElement.style.maxWidth = '70%';
            } else if (type === 'assistant') {
                messageElement.style.background = 'var(--bg-tertiary)';
                messageElement.style.color = 'var(--text-primary)';
                messageElement.style.marginLeft = '0';
                messageElement.style.marginRight = 'auto';
                messageElement.style.maxWidth = '70%';
            } else if (type === 'system') {
                messageElement.style.background = 'var(--warning-100)';
                messageElement.style.color = 'var(--warning-700)';
                messageElement.style.border = '1px solid var(--warning-300)';
                messageElement.style.marginLeft = '0';
                messageElement.style.marginRight = 'auto';
                messageElement.style.maxWidth = '50%';
                messageElement.style.fontStyle = 'italic';
                messageElement.style.opacity = '0.8';
            } else if (type === 'error') {
                messageElement.style.background = 'var(--danger-100)';
                messageElement.style.color = 'var(--danger-700)';
                messageElement.style.border = '1px solid var(--danger-300)';
                messageElement.style.marginLeft = '0';
                messageElement.style.marginRight = 'auto';
                messageElement.style.maxWidth = '70%';
            }
            
            messageElement.style.padding = 'var(--space-3) var(--space-4)';
            messageElement.style.borderRadius = 'var(--radius-lg)';
            messageElement.style.display = 'block';
            
            messageElement.textContent = message;
            
            messagesContainer.appendChild(messageElement);
            
            // Animate message
            if (window.animationUtils) {
                window.animationUtils.animateMessage(messageElement, type);
            }
            
            // Scroll to bottom
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        // Real API functions
        function showMemoryModal() {
            // Load conversation history
            fetch('/api/memory/conversations')
                .then(response => response.json())
                .then(data => {
                    console.log('📜 Conversation history:', data);
                    alert('Konuşma geçmişi konsola yazdırıldı.');
                })
                .catch(error => {
                    console.error('❌ Memory load error:', error);
                    alert('Konuşma geçmişi yüklenemedi.');
                });
        }

        function showTasksModal() {
            // Load active tasks
            fetch('/api/memory/tasks')
                .then(response => response.json())
                .then(data => {
                    console.log('📋 Active tasks:', data);
                    alert('Aktif görevler konsola yazdırıldı.');
                })
                .catch(error => {
                    console.error('❌ Tasks load error:', error);
                    alert('Görevler yüklenemedi.');
                });
        }

        function startAIConversation() {
            const prompt = document.getElementById('initial-prompt')?.value || 'AI destekli bir proje geliştiriyoruz. Önceliklerimizi belirleyelim.';
            const maxTurns = parseInt(document.getElementById('max-turns')?.value) || 3;
            
            // Update UI
            const startBtn = document.getElementById('start-conversation');
            const pauseBtn = document.getElementById('pause-conversation');
            const statusSpan = document.getElementById('conversation-status');
            
            if (startBtn) startBtn.disabled = true;
            if (pauseBtn) pauseBtn.disabled = false;
            if (statusSpan) statusSpan.textContent = 'Başlatılıyor...';
            
            // Clear chat messages
            const messagesContainer = document.getElementById('live-chat-messages');
            if (messagesContainer) {
                messagesContainer.innerHTML = '<div class="text-center text-muted p-3"><i class="bi bi-hourglass-split"></i> AI konuşması başlatılıyor...</div>';
            }
            
            // Start conversation via API
            fetch('/api/ai/conversation', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    prompt: prompt,  // Backend 'prompt' bekliyor, 'initial_prompt' değil
                    max_turns: maxTurns
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'started') {
                    console.log('🚀 Conversation started:', data);
                    if (statusSpan) statusSpan.textContent = 'Aktif';
                    
                    // Show conversation started message
                    if (messagesContainer) {
                        messagesContainer.innerHTML = `
                            <div class="text-center text-muted p-3">
                                <i class="bi bi-chat-dots text-success"></i> 
                                AI konuşması başlatıldı!<br>
                                <small>Prompt: "${data.prompt}"</small><br>
                                <small>Max ${data.max_turns} tur</small>
                            </div>
                        `;
                    }
                } else if (data.error) {
                    console.error('❌ Conversation start failed:', data.error);
                    if (statusSpan) statusSpan.textContent = 'Hata: ' + data.error;
                    if (startBtn) startBtn.disabled = false;
                    if (pauseBtn) pauseBtn.disabled = true;
                } else {
                    console.error('❌ Unexpected response:', data);
                    if (statusSpan) statusSpan.textContent = 'Beklenmeyen yanıt';
                    if (startBtn) startBtn.disabled = false;
                    if (pauseBtn) pauseBtn.disabled = true;
                }
            })
            .catch(error => {
                console.error('❌ Conversation API error:', error);
                if (statusSpan) statusSpan.textContent = 'Bağlantı hatası';
                if (startBtn) startBtn.disabled = false;
                if (pauseBtn) pauseBtn.disabled = true;
                alert('Konuşma başlatılamadı: ' + error.message);
            });
        }

        function pauseConversation() {
            console.log('⏸️ Conversation paused');
            const startBtn = document.getElementById('start-conversation');
            const pauseBtn = document.getElementById('pause-conversation');
            const statusSpan = document.getElementById('conversation-status');
            
            if (startBtn) startBtn.disabled = false;
            if (pauseBtn) pauseBtn.disabled = true;
            if (statusSpan) statusSpan.textContent = 'Duraklatıldı';
        }

        function clearConversation() {
            const messagesContainer = document.getElementById('live-chat-messages');
            if (messagesContainer) {
                messagesContainer.innerHTML = `
                    <div class="text-center text-muted p-5">
                        <div class="floating">
                            <i class="bi bi-robot" style="font-size: 48px; opacity: 0.3;"></i>
                        </div>
                        <p class="mt-3 mb-0">AI konuşması başlatılmayı bekliyor...</p>
                        <small class="text-muted">Yukarıdaki "Başlat" butonuna tıklayın</small>
                    </div>
                `;
            }
            
            const statusSpan = document.getElementById('conversation-status');
            if (statusSpan) statusSpan.textContent = 'Beklemede';
            
            const startBtn = document.getElementById('start-conversation');
            const pauseBtn = document.getElementById('pause-conversation');
            if (startBtn) startBtn.disabled = false;
            if (pauseBtn) pauseBtn.disabled = true;
        }

        function startConversation() {
            // Start a new manual chat conversation
            const prompt = document.getElementById('initial-prompt')?.value || 'Merhaba, nasıl yardımcı olabilirim?';
            
            // Show loading message
            addChatMessage(prompt, 'user');
            addChatMessage('⏳ Yanıt bekleniyor...', 'system');
            
            // Send initial message
            fetch('/api/ai/send_message', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    message: prompt,
                    role: 'project_manager'
                })
            })
            .then(response => {
                console.log('📤 Response status:', response.status);
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                return response.json();
            })
            .then(data => {
                console.log('📥 Response data:', data);
                
                // Remove loading message
                const messages = document.getElementById('chat-messages');
                const lastMessage = messages.lastElementChild;
                if (lastMessage && lastMessage.textContent.includes('⏳')) {
                    messages.removeChild(lastMessage);
                }
                
                if (data.success && data.response) {
                    addChatMessage(data.response, 'assistant');
                } else if (data.status === 'processing') {
                    // AI still processing - update message
                    const messages = document.getElementById('chat-messages');
                    const lastMessage = messages.lastElementChild;
                    if (lastMessage && lastMessage.textContent.includes('⏳')) {
                        lastMessage.textContent = `🤖 ${data.role_id} işleniyor...`;
                    }
                    
                    // Poll for result with timeout
                    setTimeout(() => {
                        const messages = document.getElementById('chat-messages');
                        const lastMessage = messages.lastElementChild;
                        if (lastMessage && lastMessage.textContent.includes('işleniyor')) {
                            lastMessage.textContent = '⚠️ Yanıt alma süresi aşıldı. Lütfen tekrar deneyin.';
                            lastMessage.style.background = 'var(--danger-100)';
                            lastMessage.style.color = 'var(--danger-700)';
                        }
                    }, 10000); // 10 second timeout
                } else if (data.error) {
                    addChatMessage('❌ Hata: ' + data.error, 'error');
                } else {
                    console.log('🔍 Full response data:', JSON.stringify(data, null, 2));
                    addChatMessage('❌ Beklenmeyen yanıt formatı: ' + JSON.stringify(data), 'error');
                }
            })
            .catch(error => {
                console.error('❌ Send message error:', error);
                
                // Remove loading message
                const messages = document.getElementById('chat-messages');
                const lastMessage = messages.lastElementChild;
                if (lastMessage && lastMessage.textContent.includes('⏳')) {
                    messages.removeChild(lastMessage);
                }
                
                addChatMessage('❌ Bağlantı hatası: ' + error.message, 'error');
            });
        }

        function clearHistory() {
            const messagesContainer = document.getElementById('chat-messages');
            if (messagesContainer) {
                messagesContainer.innerHTML = `
                    <div class="text-center text-muted p-5">
                        <i class="bi bi-chat-dots floating" style="font-size: 48px; opacity: 0.3;"></i>
                        <p class="mt-3">Henüz konuşma yok. Aşağıdan bir konuşma başlatın.</p>
                    </div>
                `;
            }
        }

        function toggleInterventionPanel() {
            // Director intervention feature
            const intervention = prompt('Müdahale mesajınızı yazın:');
            if (intervention && intervention.trim()) {
                fetch('/api/ai/intervention', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        intervention: intervention,
                        session_id: 'current'
                    })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        console.log('📢 Intervention sent:', data);
                        alert('Müdahale başarıyla gönderildi!');
                    } else {
                        console.error('❌ Intervention failed:', data.error);
                        alert('Müdahale gönderilemedi: ' + data.error);
                    }
                })
                .catch(error => {
                    console.error('❌ Intervention error:', error);
                    alert('Müdahale hatası: ' + error.message);
                });
            }
        }

        // === 🧠 AI Document Synthesizer Functions ===

        function generateDocument() {
            if (!currentSessionId) {
                alert('Aktif bir konuşma yok! Önce AI konuşması başlatın.');
                return;
            }

            const documentType = document.getElementById('document-type-selector').value;
            const statusContainer = document.getElementById('document-generation-status');
            const generateBtn = document.getElementById('generate-document-btn');

            // UI güncellemeleri
            generateBtn.disabled = true;
            generateBtn.innerHTML = '<i class="bi bi-hourglass-split"></i> AI Sentezliyor...';
            
            statusContainer.innerHTML = `
                <div class="alert alert-info mb-0">
                    <i class="bi bi-magic"></i>
                    <strong>AI Analizi Başlatıldı!</strong><br>
                    <small>Konuşma analiz ediliyor ve "${getDocumentTypeName(documentType)}" belgesi oluşturuluyor...</small>
                </div>
            `;

            console.log(`🧠 Generating ${documentType} for session ${currentSessionId}`);

            fetch('/api/documents/generate', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    session_id: currentSessionId,
                    document_type: documentType
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'generating') {
                    console.log('✅ Document generation started');
                    statusContainer.innerHTML = `
                        <div class="alert alert-warning mb-0">
                            <i class="bi bi-clock-history"></i>
                            <strong>İşlem Devam Ediyor...</strong><br>
                            <small>AI belge sentezi arka planda çalışıyor. Tamamlandığında bildirim alacaksınız.</small>
                        </div>
                    `;
                } else {
                    throw new Error(data.error || 'Bilinmeyen hata');
                }
            })
            .catch(error => {
                console.error('❌ Document generation error:', error);
                statusContainer.innerHTML = `
                    <div class="alert alert-danger mb-0">
                        <i class="bi bi-exclamation-triangle"></i>
                        <strong>Hata:</strong> ${error.message}
                    </div>
                `;
            })
            .finally(() => {
                generateBtn.disabled = false;
                generateBtn.innerHTML = '<i class="bi bi-magic"></i> AI Belge Üret';
            });
        }

        function showDocumentGenerationSuccess(data) {
            const statusContainer = document.getElementById('document-generation-status');
            
            statusContainer.innerHTML = `
                <div class="alert alert-success mb-0">
                    <i class="bi bi-check-circle"></i>
                    <strong>✅ Belge Başarıyla Oluşturuldu!</strong><br>
                    <small><strong>${data.title}</strong></small><br>
                    <div class="mt-2">
                        ${Object.keys(data.file_paths).map(format => 
                            `<a href="/api/documents/${data.document_id}/download/${format}" 
                               class="btn btn-sm btn-outline-success me-1" target="_blank">
                               <i class="bi bi-download"></i> ${format.toUpperCase()}
                            </a>`
                        ).join('')}
                    </div>
                </div>
            `;

            // Auto-clear success message after 10 seconds
            setTimeout(() => {
                statusContainer.innerHTML = '';
            }, 10000);

            // Show notification
            if (window.Notification && Notification.permission === 'granted') {
                new Notification('AI Belge Hazır!', {
                    body: `"${data.title}" belgesi başarıyla oluşturuldu.`,
                    icon: '/static/favicon.ico'
                });
            }
        }

        function showDocumentGenerationError(error) {
            const statusContainer = document.getElementById('document-generation-status');
            
            statusContainer.innerHTML = `
                <div class="alert alert-danger mb-0">
                    <i class="bi bi-exclamation-triangle"></i>
                    <strong>Belge Üretim Hatası:</strong><br>
                    <small>${error}</small>
                </div>
            `;

            // Auto-clear error message after 8 seconds
            setTimeout(() => {
                statusContainer.innerHTML = '';
            }, 8000);
        }

        function loadDocumentStatistics() {
            const statsContainer = document.getElementById('document-statistics');
            
            fetch('/api/documents/statistics')
                .then(response => response.json())
                .then(stats => {
                    console.log('📊 Document Statistics:', stats);
                    
                    const statsHtml = `
                        <div class="row g-2 text-center">
                            <div class="col-6">
                                <div class="p-2 bg-light rounded">
                                    <strong class="text-primary">${stats.total_documents}</strong><br>
                                    <small class="text-muted">Toplam Belge</small>
                                </div>
                            </div>
                            <div class="col-6">
                                <div class="p-2 bg-light rounded">
                                    <strong class="text-success">${stats.document_types.meeting_summary}</strong><br>
                                    <small class="text-muted">Meeting Summary</small>
                                </div>
                            </div>
                            <div class="col-6">
                                <div class="p-2 bg-light rounded">
                                    <strong class="text-warning">${stats.document_types.action_items}</strong><br>
                                    <small class="text-muted">Action Items</small>
                                </div>
                            </div>
                            <div class="col-6">
                                <div class="p-2 bg-light rounded">
                                    <strong class="text-info">${stats.document_types.decisions_log}</strong><br>
                                    <small class="text-muted">Decisions Log</small>
                                </div>
                            </div>
                        </div>
                        ${stats.total_insights ? `
                        <hr class="my-2">
                        <div class="text-center">
                            <small class="text-muted">
                                📊 ${stats.total_insights.key_points} Key Points • 
                                ✅ ${stats.total_insights.decisions} Decisions • 
                                📋 ${stats.total_insights.action_items} Actions
                            </small>
                        </div>
                        ` : ''}
                    `;
                    
                    statsContainer.innerHTML = statsHtml;
                })
                .catch(error => {
                    console.error('❌ Statistics load error:', error);
                    statsContainer.innerHTML = `
                        <div class="text-center text-muted">
                            <small>📊 İstatistik yüklenemedi</small>
                        </div>
                    `;
                });
        }

        function showDocumentsModal() {
            // Simple implementation - would show modal in real app
            fetch('/api/documents')
                .then(response => response.json())
                .then(data => {
                    console.log('📚 Documents Library:', data);
                    if (data.documents.length === 0) {
                        alert('Henüz belge oluşturulmamış.');
                    } else {
                        let message = `📚 Generated Documents (${data.count}):\n\n`;
                        data.documents.forEach((doc, index) => {
                            message += `${index + 1}. ${doc.title}\n`;
                            message += `   Type: ${doc.document_type}\n`;
                            message += `   Created: ${new Date(doc.created_at).toLocaleString()}\n\n`;
                        });
                        alert(message);
                    }
                })
                .catch(error => {
                    console.error('❌ Documents load error:', error);
                    alert('Belge listesi yüklenemedi: ' + error.message);
                });
        }

        function getDocumentTypeName(type) {
            const typeNames = {
                'meeting_summary': 'Toplantı Özeti',
                'action_items': 'Eylem Planı', 
                'decisions_log': 'Karar Defteri'
            };
            return typeNames[type] || type;
        }

        // Initialize document generation UI states
        function updateDocumentGenerationUI() {
            const generateBtn = document.getElementById('generate-document-btn');
            
            if (currentSessionId && orchestrationActive) {
                generateBtn.disabled = false;
                generateBtn.title = 'Aktif konuşmadan belge üret';
            } else {
                generateBtn.disabled = true;
                generateBtn.title = 'Belge üretmek için önce AI konuşması başlatın';
            }
        }

        // Request notification permission
        if (window.Notification && Notification.permission === 'default') {
            Notification.requestPermission();
        }

        // ===== 🎨 LIVE DOCUMENT CANVAS FUNCTIONS ===== //

        // Canvas Variables
        let canvasWindows = new Map();
        let canvasSocket = null;
        let canvasZIndex = 1000;
        let dragState = { isDragging: false, element: null, offsetX: 0, offsetY: 0 };

        // Initialize Canvas on page load
        document.addEventListener('DOMContentLoaded', function() {
            initializeCanvas();
            loadCanvasStatistics();
        });

        function initializeCanvas() {
            console.log('🎨 Initializing Live Document Canvas...');
            
            // Initialize canvas-specific socket events
            if (socket) {
                // Document events
                socket.on('document_created', function(data) {
                    console.log('📄 Document created:', data);
                    updateCanvasStatistics();
                });
                
                socket.on('document_updated', function(data) {
                    console.log('✏️ Document updated:', data);
                    // Update specific window content if it's open
                    const window = canvasWindows.get(data.document_id);
                    if (window && window.editor) {
                        // Apply changes to editor
                        applyDocumentChanges(window.editor, data.changes);
                    }
                });
                
                socket.on('ai_editing', function(data) {
                    console.log('🤖 AI is editing:', data);
                    showAITypingIndicator(data.document_id, data.ai_name);
                });
            }
            
            console.log('✅ Canvas initialized successfully!');
        }

        // Canvas Control Functions
        function createNewDocument() {
            const documentType = document.getElementById('canvas-document-type').value;
            const documentTitle = document.getElementById('canvas-document-title').value || `Yeni ${documentType} Belgesi`;
            
            console.log(`🎨 Creating new ${documentType} document: ${documentTitle}`);
            
            fetch('/api/canvas/documents', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    title: documentTitle,
                    document_type: documentType,
                    content: ''
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    console.log('✅ Document created successfully:', data);
                    // Create floating window for this document
                    createFloatingWindow(data.document);
                    updateCanvasStatistics();
                    
                    // Clear input
                    document.getElementById('canvas-document-title').value = '';
                } else {
                    console.error('❌ Document creation failed:', data);
                    alert('Belge oluşturulamadı: ' + (data.error || 'Bilinmeyen hata'));
                }
            })
            .catch(error => {
                console.error('❌ Document creation error:', error);
                alert('Belge oluşturma hatası: ' + error.message);
            });
        }

        function launchCanvasDocument() {
            createNewDocument();
        }

        // Floating Window Management
        function createFloatingWindow(document) {
            const windowId = `canvas_window_${Date.now()}`;
            const container = document.getElementById('canvas-container');
            const emptyState = document.getElementById('canvas-empty-state');
            
            // Hide empty state
            if (emptyState) {
                emptyState.style.display = 'none';
            }
            
            // Calculate position (cascade style)
            const windowCount = canvasWindows.size;
            const offsetX = 20 + (windowCount * 30);
            const offsetY = 20 + (windowCount * 30);
            
            // Create window element
            const windowElement = document.createElement('div');
            windowElement.className = 'canvas-window focused';
            windowElement.id = windowId;
            windowElement.style.left = `${offsetX}px`;
            windowElement.style.top = `${offsetY}px`;
            windowElement.style.width = '600px';
            windowElement.style.height = '400px';
            windowElement.style.zIndex = ++canvasZIndex;
            
            windowElement.innerHTML = `
                <div class="canvas-window-header">
                    <h6 class="canvas-window-title">${document.title}</h6>
                    <div class="canvas-document-type ${document.document_type}">${document.document_type}</div>
                    <div class="canvas-window-controls">
                        <button class="canvas-window-control minimize" onclick="minimizeWindow('${windowId}')" title="Küçült">
                            <i class="bi bi-dash"></i>
                        </button>
                        <button class="canvas-window-control maximize" onclick="maximizeWindow('${windowId}')" title="Büyüt">
                            <i class="bi bi-arrows-fullscreen"></i>
                        </button>
                        <button class="canvas-window-control close" onclick="closeWindow('${windowId}')" title="Kapat">
                            <i class="bi bi-x"></i>
                        </button>
                    </div>
                </div>
                <div class="canvas-toolbar">
                    <button class="canvas-toolbar-button" onclick="formatText('${windowId}', 'bold')" title="Kalın">
                        <i class="bi bi-type-bold"></i>
                    </button>
                    <button class="canvas-toolbar-button" onclick="formatText('${windowId}', 'italic')" title="İtalik">
                        <i class="bi bi-type-italic"></i>
                    </button>
                    <button class="canvas-toolbar-button" onclick="formatText('${windowId}', 'heading', 1)" title="Başlık 1">
                        H1
                    </button>
                    <button class="canvas-toolbar-button" onclick="formatText('${windowId}', 'heading', 2)" title="Başlık 2">
                        H2
                    </button>
                    <button class="canvas-toolbar-button" onclick="formatText('${windowId}', 'bulletList')" title="Liste">
                        <i class="bi bi-list-ul"></i>
                    </button>
                    <button class="canvas-toolbar-button" onclick="formatText('${windowId}', 'blockquote')" title="Alıntı">
                        <i class="bi bi-quote"></i>
                    </button>
                    <button class="canvas-toolbar-button" onclick="inviteAI('${windowId}')" title="AI Davet Et">
                        <i class="bi bi-robot"></i> AI
                    </button>
                </div>
                <div class="canvas-window-content">
                    <div class="canvas-editor" id="editor_${windowId}"></div>
                </div>
            `;
            
            // Add to container
            container.appendChild(windowElement);
            
            // Initialize rich text editor
            const editor = initializeEditor(`editor_${windowId}`, document);
            
            // Store window reference
            canvasWindows.set(windowId, {
                element: windowElement,
                document: document,
                editor: editor,
                isMinimized: false,
                originalSize: { width: 600, height: 400 }
            });
            
            // Add event listeners for dragging
            setupWindowDragging(windowElement);
            
            // Focus this window
            focusWindow(windowId);
            
            // Update statistics
            updateActiveWindowsCount();
            
            console.log(`🪟 Created floating window: ${windowId} for document: ${document.title}`);
        }

        function initializeEditor(elementId, document) {
            const element = document.getElementById(elementId);
            if (!element) return null;
            
            try {
                // Initialize Tiptap editor
                const editor = new Tiptap.Editor({
                    element: element,
                    extensions: [
                        Tiptap.StarterKit,
                    ],
                    content: document.content || '<p>Buraya yazmaya başlayın...</p>',
                    onUpdate: ({ editor }) => {
                        // Auto-save document changes
                        const content = editor.getHTML();
                        saveDocumentContent(document.id, content);
                    },
                    editorProps: {
                        attributes: {
                            class: 'canvas-editor'
                        }
                    }
                });
                
                console.log(`✏️ Editor initialized for ${elementId}`);
                return editor;
            } catch (error) {
                console.error('❌ Editor initialization error:', error);
                // Fallback to simple contenteditable
                element.innerHTML = document.content || '<p>Buraya yazmaya başlayın...</p>';
                element.contentEditable = true;
                return { getHTML: () => element.innerHTML, setContent: (content) => element.innerHTML = content };
            }
        }

        // Window Control Functions
        function minimizeWindow(windowId) {
            const window = canvasWindows.get(windowId);
            if (!window) return;
            
            if (window.isMinimized) {
                // Restore
                window.element.classList.remove('minimized');
                window.element.style.height = window.originalSize.height + 'px';
                window.isMinimized = false;
            } else {
                // Minimize
                window.originalSize.height = window.element.offsetHeight;
                window.element.classList.add('minimized');
                window.isMinimized = true;
            }
        }

        function maximizeWindow(windowId) {
            const window = canvasWindows.get(windowId);
            if (!window) return;
            
            const container = document.getElementById('canvas-container');
            const containerRect = container.getBoundingClientRect();
            
            window.element.style.left = '10px';
            window.element.style.top = '10px';
            window.element.style.width = (containerRect.width - 20) + 'px';
            window.element.style.height = (containerRect.height - 20) + 'px';
            
            focusWindow(windowId);
        }

        function closeWindow(windowId) {
            const window = canvasWindows.get(windowId);
            if (!window) return;
            
            // Destroy editor
            if (window.editor && window.editor.destroy) {
                window.editor.destroy();
            }
            
            // Remove element
            window.element.remove();
            
            // Remove from map
            canvasWindows.delete(windowId);
            
            // Update statistics
            updateActiveWindowsCount();
            
            // Show empty state if no windows
            if (canvasWindows.size === 0) {
                const emptyState = document.getElementById('canvas-empty-state');
                if (emptyState) {
                    emptyState.style.display = 'flex';
                }
            }
            
            console.log(`🗑️ Closed window: ${windowId}`);
        }

        function focusWindow(windowId) {
            // Remove focus from all windows
            canvasWindows.forEach((window, id) => {
                window.element.classList.remove('focused');
            });
            
            // Focus this window
            const window = canvasWindows.get(windowId);
            if (window) {
                window.element.classList.add('focused');
                window.element.style.zIndex = ++canvasZIndex;
            }
        }

        // Window Dragging
        function setupWindowDragging(windowElement) {
            const header = windowElement.querySelector('.canvas-window-header');
            
            header.addEventListener('mousedown', (e) => {
                if (e.target.closest('.canvas-window-controls')) return;
                
                dragState.isDragging = true;
                dragState.element = windowElement;
                dragState.offsetX = e.clientX - windowElement.offsetLeft;
                dragState.offsetY = e.clientY - windowElement.offsetTop;
                
                document.addEventListener('mousemove', handleWindowDrag);
                document.addEventListener('mouseup', handleWindowDragEnd);
                
                // Focus this window
                const windowId = windowElement.id;
                focusWindow(windowId);
            });
        }

        function handleWindowDrag(e) {
            if (!dragState.isDragging || !dragState.element) return;
            
            const container = document.getElementById('canvas-container');
            const containerRect = container.getBoundingClientRect();
            
            const newX = e.clientX - dragState.offsetX;
            const newY = e.clientY - dragState.offsetY;
            
            // Keep within container bounds
            const maxX = containerRect.width - dragState.element.offsetWidth;
            const maxY = containerRect.height - dragState.element.offsetHeight;
            
            dragState.element.style.left = Math.max(0, Math.min(newX, maxX)) + 'px';
            dragState.element.style.top = Math.max(0, Math.min(newY, maxY)) + 'px';
        }

        function handleWindowDragEnd() {
            dragState.isDragging = false;
            dragState.element = null;
            
            document.removeEventListener('mousemove', handleWindowDrag);
            document.removeEventListener('mouseup', handleWindowDragEnd);
        }

        // Quick Actions
        function minimizeAllWindows() {
            canvasWindows.forEach((window, windowId) => {
                if (!window.isMinimized) {
                    minimizeWindow(windowId);
                }
            });
        }

        function maximizeAllWindows() {
            canvasWindows.forEach((window, windowId) => {
                maximizeWindow(windowId);
            });
        }

        function cascadeWindows() {
            let index = 0;
            canvasWindows.forEach((window, windowId) => {
                const offsetX = 20 + (index * 30);
                const offsetY = 20 + (index * 30);
                
                window.element.style.left = offsetX + 'px';
                window.element.style.top = offsetY + 'px';
                window.element.style.width = '600px';
                window.element.style.height = '400px';
                
                index++;
            });
        }

        function closeAllWindows() {
            const windowIds = Array.from(canvasWindows.keys());
            windowIds.forEach(windowId => {
                closeWindow(windowId);
            });
        }

        // Text Formatting
        function formatText(windowId, command, value = null) {
            const window = canvasWindows.get(windowId);
            if (!window || !window.editor) return;
            
            try {
                switch (command) {
                    case 'bold':
                        window.editor.chain().focus().toggleBold().run();
                        break;
                    case 'italic':
                        window.editor.chain().focus().toggleItalic().run();
                        break;
                    case 'heading':
                        window.editor.chain().focus().toggleHeading({ level: value }).run();
                        break;
                    case 'bulletList':
                        window.editor.chain().focus().toggleBulletList().run();
                        break;
                    case 'blockquote':
                        window.editor.chain().focus().toggleBlockquote().run();
                        break;
                }
            } catch (error) {
                console.error('❌ Text formatting error:', error);
            }
        }

        // AI Integration
        function inviteAI(windowId) {
            const window = canvasWindows.get(windowId);
            if (!window) return;
            
            const aiAction = prompt('AI\'ya ne yapmasını istiyorsunuz?\n\n1. "özet çıkar" - Belgeyi özetler\n2. "devam et" - Belgeyi devam ettirir\n3. "düzelt" - Gramer ve yazım hatalarını düzeltir\n4. "çevir" - Belgeyi farklı bir dile çevirir');
            
            if (!aiAction) return;
            
            console.log(`🤖 AI action requested: ${aiAction} for window ${windowId}`);
            
            // Show AI typing indicator
            showAITypingIndicator(window.document.id, 'AI Assistant');
            
            // Send AI request
            fetch('/api/canvas/ai-assist', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    document_id: window.document.id,
                    action: aiAction,
                    content: window.editor.getHTML()
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Apply AI changes
                    window.editor.setContent(data.content);
                    console.log('✅ AI assistance applied');
                } else {
                    console.error('❌ AI assistance failed:', data.error);
                    alert('AI yardımı başarısız: ' + data.error);
                }
            })
            .catch(error => {
                console.error('❌ AI assistance error:', error);
                alert('AI yardım hatası: ' + error.message);
            })
            .finally(() => {
                hideAITypingIndicator(window.document.id);
            });
        }

        // Document Management
        function saveDocumentContent(documentId, content) {
            // Auto-save with debouncing
            clearTimeout(window.saveTimer);
            window.saveTimer = setTimeout(() => {
                fetch(`/api/canvas/documents/${documentId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        content: content
                    })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        console.log('💾 Document auto-saved');
                    }
                })
                .catch(error => {
                    console.error('❌ Auto-save error:', error);
                });
            }, 1000); // 1 second debounce
        }

        // Statistics and UI Updates
        function updateCanvasStatistics() {
            loadCanvasStatistics();
        }

        function loadCanvasStatistics() {
            fetch('/api/canvas/statistics')
                .then(response => response.json())
                .then(data => {
                    console.log('📊 Canvas Statistics:', data);
                    
                    // Update statistics display
                    const totalDocs = document.getElementById('canvas-total-documents');
                    const activeUsers = document.getElementById('canvas-active-users');
                    const aiEdits = document.getElementById('canvas-ai-edits');
                    const syncStatus = document.getElementById('canvas-sync-status');
                    
                    if (totalDocs) totalDocs.textContent = data.total_documents || 0;
                    if (activeUsers) activeUsers.textContent = data.active_users || 1;
                    if (aiEdits) aiEdits.textContent = data.ai_edits || 0;
                    if (syncStatus) {
                        syncStatus.textContent = socket && socket.connected ? '🟢' : '🔴';
                        syncStatus.parentElement.querySelector('small').textContent = 
                            socket && socket.connected ? 'Bağlı' : 'Bağlantı Kesildi';
                    }
                })
                .catch(error => {
                    console.error('❌ Canvas statistics error:', error);
                });
        }

        function updateActiveWindowsCount() {
            const countElement = document.getElementById('active-windows-count');
            if (countElement) {
                countElement.textContent = canvasWindows.size;
            }
        }

        // AI Indicators
        function showAITypingIndicator(documentId, aiName) {
            // Find window with this document
            for (const [windowId, window] of canvasWindows) {
                if (window.document.id === documentId) {
                    const indicator = document.createElement('div');
                    indicator.className = 'ai-typing-indicator';
                    indicator.id = `ai-indicator-${documentId}`;
                    indicator.innerHTML = `<i class="bi bi-robot"></i> ${aiName} yazıyor...`;
                    
                    window.element.querySelector('.canvas-window-content').appendChild(indicator);
                    break;
                }
            }
        }

        function hideAITypingIndicator(documentId) {
            const indicator = document.getElementById(`ai-indicator-${documentId}`);
            if (indicator) {
                indicator.remove();
            }
        }

        // Modal Functions
        function showDocumentManager() {
            alert('Belge Yöneticisi yakında gelecek! 📚');
        }

        function showCanvasStatistics() {
            fetch('/api/canvas/statistics')
                .then(response => response.json())
                .then(data => {
                    const stats = `
🎨 Canlı Belge Tuvali İstatistikleri:

📄 Toplam Belgeler: ${data.total_documents || 0}
🪟 Aktif Pencereler: ${canvasWindows.size}
👥 Aktif Kullanıcılar: ${data.active_users || 1}
🤖 AI Düzenlemeleri: ${data.ai_edits || 0}
🔗 Sync Durumu: ${socket && socket.connected ? 'Bağlı ✅' : 'Bağlantı Kesildi ❌'}
                    `;
                    alert(stats);
                })
                .catch(error => {
                    console.error('❌ Statistics error:', error);
                    alert('İstatistikler yüklenemedi: ' + error.message);
                });
        }

        console.log('🎨 Live Document Canvas JavaScript loaded successfully!');

    </script>
</body>
</html> 