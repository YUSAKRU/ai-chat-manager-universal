<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Chrome Chat Manager</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <style>
        .chat-container {
            height: 500px;
            overflow-y: auto;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 15px;
            background-color: #f8f9fa;
        }
        .message {
            margin-bottom: 15px;
            padding: 10px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .message.pm { background-color: #e3f2fd; border-left: 4px solid #2196f3; }
        .message.ld { background-color: #f3e5f5; border-left: 4px solid #9c27b0; }
        .message.boss { background-color: #fff3e0; border-left: 4px solid #ff9800; }
        .message-header {
            font-weight: bold;
            margin-bottom: 5px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .timestamp {
            font-size: 0.8em;
            color: #666;
        }
        .status-indicator {
            height: 12px;
            width: 12px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 8px;
        }
        .status-online { background-color: #4caf50; }
        .status-offline { background-color: #f44336; }
        .stats-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
        }
    </style>
</head>
<body>
    <div class="container-fluid">
        <div class="row">
            <!-- Header -->
            <div class="col-12">
                <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
                    <div class="container-fluid">
                        <a class="navbar-brand" href="#">
                            <i class="fas fa-robot"></i> AI Chrome Chat Manager
                        </a>
                        <div class="navbar-nav ms-auto">
                            <span class="nav-item">
                                <span class="status-indicator" id="statusIndicator"></span>
                                <span id="connectionStatus">BaÄŸlanÄ±yor...</span>
                            </span>
                        </div>
                    </div>
                </nav>
            </div>
        </div>

        <div class="row mt-3">
            <!-- Sol Panel - Kontrol -->
            <div class="col-md-4">
                <!-- Sistem Durumu -->
                <div class="stats-card">
                    <h5><i class="fas fa-chart-line"></i> Sistem Durumu</h5>
                    <div class="row">
                        <div class="col-6">
                            <div class="text-center">
                                <h3 id="messageCount">0</h3>
                                <small>Toplam Mesaj</small>
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="text-center">
                                <h3 id="activeChannels">0</h3>
                                <small>Aktif Kanal</small>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- HÄ±zlÄ± Aksiyonlar -->
                <div class="card">
                    <div class="card-header">
                        <h5><i class="fas fa-lightning-bolt"></i> HÄ±zlÄ± Aksiyonlar</h5>
                    </div>
                    <div class="card-body">
                        <div class="d-grid gap-2">
                            <button class="btn btn-primary" onclick="requestStatus()">
                                <i class="fas fa-clipboard-check"></i> Durum Raporu Ä°ste
                            </button>
                            <button class="btn btn-success" onclick="showTaskModal()">
                                <i class="fas fa-tasks"></i> GÃ¶rev Ata
                            </button>
                            <button class="btn btn-warning" onclick="showBossModal()">
                                <i class="fas fa-crown"></i> Boss MÃ¼dahalesi
                            </button>
                            <button class="btn btn-info" onclick="refreshMessages()">
                                <i class="fas fa-sync"></i> MesajlarÄ± Yenile
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Memory Bank -->
                <div class="card mt-3">
                    <div class="card-header">
                        <h5><i class="fas fa-database"></i> Memory Bank</h5>
                    </div>
                    <div class="card-body">
                        <div class="input-group mb-2">
                            <input type="text" class="form-control" id="memoryQuery" placeholder="Memory Bank'Ä± sorgula...">
                            <button class="btn btn-outline-secondary" onclick="queryMemoryBank()">
                                <i class="fas fa-search"></i>
                            </button>
                        </div>
                        <div class="d-grid">                            <button class="btn btn-outline-primary btn-sm" onclick="getProjectSummary()">
                                <i class="fas fa-file-alt"></i> Proje Ã–zeti
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Chrome Profil YÃ¶netimi -->
                <div class="card mt-3">
                    <div class="card-header">
                        <h5><i class="fas fa-user-circle"></i> Chrome Profiller</h5>
                    </div>
                    <div class="card-body">
                        <div class="d-grid gap-2">
                            <button class="btn btn-outline-info btn-sm" onclick="getChromeProfiles()">
                                <i class="fas fa-list"></i> Mevcut Profiller
                            </button>
                            <button class="btn btn-outline-success btn-sm" onclick="getSelectedProfiles()">
                                <i class="fas fa-check-circle"></i> SeÃ§ilen Profiller
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- SaÄŸ Panel - Chat -->
            <div class="col-md-8">
                <div class="card">
                    <div class="card-header">
                        <h5><i class="fas fa-comments"></i> CanlÄ± KonuÅŸma</h5>
                        <div class="float-end">
                            <small class="text-muted">Son gÃ¼ncelleme: <span id="lastUpdate">-</span></small>
                        </div>
                    </div>
                    <div class="card-body">
                        <div id="chatContainer" class="chat-container">
                            <div class="text-center text-muted">
                                <i class="fas fa-comments fa-3x mb-3"></i>
                                <p>HenÃ¼z mesaj yok. KonuÅŸma baÅŸladÄ±ÄŸÄ±nda burasÄ± gÃ¼ncellenecek.</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Mesaj GÃ¶nderme -->
                <div class="card mt-3">
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-3">
                                <select class="form-select" id="messageTarget">
                                    <option value="boss_to_both">Her ikisine (Boss)</option>
                                    <option value="boss_to_pm">Proje YÃ¶neticisi'ne</option>
                                    <option value="boss_to_ld">Lead Developer'a</option>
                                </select>
                            </div>
                            <div class="col-md-7">
                                <input type="text" class="form-control" id="messageInput" placeholder="Mesaj yazÄ±n..." onkeypress="handleKeyPress(event)">
                            </div>
                            <div class="col-md-2">
                                <button class="btn btn-primary w-100" onclick="sendMessage()">
                                    <i class="fas fa-paper-plane"></i> GÃ¶nder
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modals and JavaScript here -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Socket.IO baÄŸlantÄ±sÄ±
        const socket = io();
        let messageHistory = [];

        socket.on('connect', function() {
            document.getElementById('statusIndicator').className = 'status-indicator status-online';
            document.getElementById('connectionStatus').textContent = 'BaÄŸlÄ±';
        });

        socket.on('disconnect', function() {
            document.getElementById('statusIndicator').className = 'status-indicator status-offline';
            document.getElementById('connectionStatus').textContent = 'BaÄŸlantÄ± Kesildi';
        });

        socket.on('new_message', function(message) {
            addMessageToChat(message);
        });

        function addMessageToChat(message) {
            const chatContainer = document.getElementById('chatContainer');
            if (messageHistory.length === 0) {
                chatContainer.innerHTML = '';
            }

            const messageDiv = document.createElement('div');
            const senderClass = getSenderClass(message.sender);
            const timestamp = new Date(message.timestamp).toLocaleTimeString();

            messageDiv.className = `message ${senderClass}`;
            messageDiv.innerHTML = `
                <div class="message-header">
                    <span><i class="${getSenderIcon(message.sender)}"></i> ${message.sender}</span>
                    <span class="timestamp">${timestamp}</span>
                </div>
                <div>${message.content}</div>
            `;

            chatContainer.appendChild(messageDiv);
            chatContainer.scrollTop = chatContainer.scrollHeight;
            messageHistory.push(message);
        }

        function getSenderClass(sender) {
            if (sender.includes('Proje') || sender.includes('Project')) return 'pm';
            if (sender.includes('Developer') || sender.includes('GeliÅŸtirici')) return 'ld';
            if (sender.includes('Boss') || sender.includes('Patron')) return 'boss';
            return 'pm';
        }

        function getSenderIcon(sender) {
            if (sender.includes('Proje') || sender.includes('Project')) return 'fas fa-user-tie';
            if (sender.includes('Developer') || sender.includes('GeliÅŸtirici')) return 'fas fa-code';
            if (sender.includes('Boss') || sender.includes('Patron')) return 'fas fa-crown';
            return 'fas fa-user';
        }

        function sendMessage() {
            const input = document.getElementById('messageInput');
            const target = document.getElementById('messageTarget').value;
            const message = input.value.trim();

            if (!message) return;

            socket.emit('send_message', {
                channel: target,
                message: message,
                sender: 'Web User'
            });

            input.value = '';
        }

        function handleKeyPress(event) {
            if (event.key === 'Enter') {
                sendMessage();
            }
        }

        function requestStatus() {
            socket.emit('request_status');
        }

        function showTaskModal() {
            alert('GÃ¶rev atama modal\'i henÃ¼z implement edilmedi.');
        }

        function showBossModal() {
            alert('Boss modal\'i henÃ¼z implement edilmedi.');
        }

        function refreshMessages() {
            fetch('/api/messages?limit=20')
                .then(response => response.json())
                .then(messages => {
                    const chatContainer = document.getElementById('chatContainer');
                    chatContainer.innerHTML = '';
                    messageHistory = [];
                    
                    if (messages.length === 0) {
                        chatContainer.innerHTML = `
                            <div class="text-center text-muted">
                                <i class="fas fa-comments fa-3x mb-3"></i>
                                <p>HenÃ¼z mesaj yok. KonuÅŸma baÅŸladÄ±ÄŸÄ±nda burasÄ± gÃ¼ncellenecek.</p>
                            </div>
                        `;
                    } else {
                        messages.forEach(message => addMessageToChat(message));
                    }
                });
        }        function queryMemoryBank() {
            const query = document.getElementById('memoryQuery').value.trim();
            if (!query) return;
            
            fetch('/api/memory_bank/query', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ query: query })
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    alert('Hata: ' + data.error);
                } else {
                    // Sonucu chat alanÄ±na ekle
                    const result = {
                        sender: 'Memory Bank',
                        content: `ðŸ§  Sorgu: "${query}"\nðŸ“‹ SonuÃ§: ${data.result}`,
                        timestamp: new Date().toISOString(),
                        channel: 'memory_bank'
                    };
                    addMessageToChat(result);
                }
            })
            .catch(error => {
                console.error('Memory Bank sorgu hatasÄ±:', error);
                alert('Memory Bank sorgusu baÅŸarÄ±sÄ±z!');
            });
        }

        function getProjectSummary() {
            fetch('/api/memory_bank/status')
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    alert('Hata: ' + data.error);
                } else {
                    const summary = {
                        sender: 'Memory Bank',
                        content: `ðŸ“Š Memory Bank Durumu:\nâœ… BaÅŸlatÄ±ldÄ±: ${data.initialized}\nðŸ“„ DokÃ¼man SayÄ±sÄ±: ${data.documents_count}\nðŸ“ Konum: ${data.path}`,
                        timestamp: new Date().toISOString(),
                        channel: 'memory_bank'
                    };
                    addMessageToChat(summary);
                }
            })            .catch(error => {
                console.error('Memory Bank durum hatasÄ±:', error);
                alert('Memory Bank durumu alÄ±namadÄ±!');
            });
        }

        // Chrome Profil YÃ¶netimi FonksiyonlarÄ±
        function getChromeProfiles() {
            fetch('/api/chrome_profiles/list')
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    alert('Hata: ' + data.error);
                } else {
                    let profilesList = "ðŸ” Mevcut Chrome Profilleri:\\n\\n";
                    profilesList += `ðŸ“ User Data: ${data.user_data_path}\\n`;
                    profilesList += `ðŸ“Š Toplam: ${data.count} profil\\n\\n`;
                    
                    data.profiles.forEach(profile => {
                        const marker = profile.is_default ? "ðŸ‘‘" : "ðŸ‘¤";
                        profilesList += `${marker} ${profile.display_name}\\n`;
                        profilesList += `   ðŸ“‚ ${profile.name}\\n`;
                        profilesList += `   ðŸ•’ ${profile.last_used}\\n\\n`;
                    });
                    
                    const result = {
                        sender: 'Chrome Profil Manager',
                        content: profilesList,
                        timestamp: new Date().toISOString(),
                        channel: 'chrome_profiles'
                    };
                    addMessageToChat(result);
                }
            })
            .catch(error => {
                console.error('Chrome profil listesi hatasÄ±:', error);
                alert('Chrome profilleri alÄ±namadÄ±!');
            });
        }

        function getSelectedProfiles() {
            fetch('/api/chrome_profiles/selected')
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    alert('Hata: ' + data.error);
                } else {
                    const selectedInfo = `ðŸŽ­ SeÃ§ilen Chrome Profilleri:\\n\\nðŸ‘” Proje YÃ¶neticisi: ${data.pm_profile}\\nðŸ‘¨â€ðŸ’» Lead Developer: ${data.ld_profile}`;
                    
                    const result = {
                        sender: 'Chrome Profil Manager',
                        content: selectedInfo,
                        timestamp: new Date().toISOString(),
                        channel: 'chrome_profiles'
                    };
                    addMessageToChat(result);
                }
            })
            .catch(error => {
                console.error('SeÃ§ilen profil hatasÄ±:', error);
                alert('SeÃ§ilen profiller alÄ±namadÄ±!');
            });
        }
    </script>
</body>
</html>